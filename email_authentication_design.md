# è–¬å±€ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ï¼šãƒ¡ãƒ¼ãƒ«èªè¨¼ãƒ»ãƒ¡ãƒ¼ãƒ«æ©Ÿèƒ½è¨­è¨ˆæ›¸

## ç›®æ¬¡
1. ãƒ¡ãƒ¼ãƒ«èªè¨¼ã®ä»•çµ„ã¿
2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒ
3. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…
4. ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§
5. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…
6. ãƒ¡ãƒ¼ãƒ«ã‚µãƒ¼ãƒ“ã‚¹é¸æŠ
7. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–
8. å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

---

## 1. ãƒ¡ãƒ¼ãƒ«èªè¨¼ã®ä»•çµ„ã¿

### 1.1 ãƒ•ãƒ­ãƒ¼å›³

```
ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²æ™‚ã€‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²  â”‚
â”‚ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ã‚µãƒ¼ãƒãƒ¼å‡¦ç†              â”‚
â”‚1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ã‚³ãƒ¼ãƒ‰ä½œæˆ   â”‚
â”‚   - email_verified: falseâ”‚
â”‚   - tokenç”Ÿæˆï¼ˆ32ãƒã‚¤ãƒˆï¼‰â”‚
â”‚   - æœ‰åŠ¹æœŸé™: 24æ™‚é–“     â”‚
â”‚2. èªè¨¼ãƒ¡ãƒ¼ãƒ«é€ä¿¡         â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒ¼ãƒ«  â”‚
â”‚ã«èªè¨¼ãƒªãƒ³ã‚¯é€ä¿¡  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒªãƒ³ã‚¯  â”‚
â”‚ã‚’ã‚¯ãƒªãƒƒã‚¯        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ã‚µãƒ¼ãƒãƒ¼ã§èªè¨¼å‡¦ç†        â”‚
â”‚1. ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼           â”‚
â”‚2. email_verified: true   â”‚
â”‚3. ãƒˆãƒ¼ã‚¯ãƒ³å‰Šé™¤           â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚èªè¨¼å®Œäº†ç”»é¢è¡¨ç¤º  â”‚
â”‚â†’ãƒ­ã‚°ã‚¤ãƒ³å¯èƒ½ã«  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚¤ãƒ³ãƒˆ

```
âœ… ãƒˆãƒ¼ã‚¯ãƒ³ã¯æš—å·å­¦çš„ã«å®‰å…¨ãªæ–¹æ³•ã§ç”Ÿæˆï¼ˆcrypto.randomBytesï¼‰
âœ… ãƒˆãƒ¼ã‚¯ãƒ³ã¯ä¸€åº¦ã®ã¿ä½¿ç”¨å¯èƒ½
âœ… 24æ™‚é–“ã®æœ‰åŠ¹æœŸé™
âœ… HTTPSå¿…é ˆ
âœ… ãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼ˆãƒ¡ãƒ¼ãƒ«é€ä¿¡ã¯15åˆ†ã§3å›ã¾ã§ï¼‰
```

---

## 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒ

### 2.1 usersãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®è¿½åŠ ã‚«ãƒ©ãƒ 

```sql
-- ãƒ¡ãƒ¼ãƒ«èªè¨¼ç”¨ã‚«ãƒ©ãƒ ã‚’è¿½åŠ 
ALTER TABLE users ADD COLUMN email_verified BOOLEAN DEFAULT FALSE;
ALTER TABLE users ADD COLUMN verification_token VARCHAR(255);
ALTER TABLE users ADD COLUMN verification_token_expires_at TIMESTAMP;

-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆç”¨ã‚«ãƒ©ãƒ ã‚’è¿½åŠ 
ALTER TABLE users ADD COLUMN reset_password_token VARCHAR(255);
ALTER TABLE users ADD COLUMN reset_password_token_expires_at TIMESTAMP;

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆï¼ˆæ¤œç´¢é«˜é€ŸåŒ–ï¼‰
CREATE INDEX idx_users_verification_token ON users(verification_token);
CREATE INDEX idx_users_reset_password_token ON users(reset_password_token);
```

### 2.2 æ›´æ–°å¾Œã®usersãƒ†ãƒ¼ãƒ–ãƒ«

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    password TEXT NOT NULL,
    user_type VARCHAR(20) NOT NULL CHECK (user_type IN ('pharmacy', 'pharmacist', 'admin')),
    is_active BOOLEAN DEFAULT TRUE,
    
    -- ãƒ¡ãƒ¼ãƒ«èªè¨¼
    email_verified BOOLEAN DEFAULT FALSE,
    verification_token VARCHAR(255),
    verification_token_expires_at TIMESTAMP,
    
    -- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ
    reset_password_token VARCHAR(255),
    reset_password_token_expires_at TIMESTAMP,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_login_at TIMESTAMP
);
```

---

## 3. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…

### 3.1 å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸

```bash
# ãƒ¡ãƒ¼ãƒ«é€ä¿¡
npm install nodemailer

# ã¾ãŸã¯ SendGrid
npm install @sendgrid/mail

# ã¾ãŸã¯ Resendï¼ˆæ¨å¥¨ï¼‰
npm install resend

# ãã®ä»–
npm install bcrypt
npm install jsonwebtoken
npm install express-rate-limit
```

### 3.2 ç’°å¢ƒå¤‰æ•°ï¼ˆ.envï¼‰

```env
# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
NODE_ENV=production
PORT=3000
FRONTEND_URL=https://example.com

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
DATABASE_URL=postgresql://user:password@localhost:5432/pharmacy_db

# JWT
JWT_SECRET=your-super-secret-key-change-this
JWT_EXPIRES_IN=24h

# ãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆNodemailer + Gmailï¼‰
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASSWORD=your-app-password
FROM_EMAIL=noreply@example.com
FROM_NAME=è–¬å±€ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 

# ã¾ãŸã¯ SendGrid
SENDGRID_API_KEY=SG.xxxxxxxxxxxx

# ã¾ãŸã¯ Resendï¼ˆæ¨å¥¨ï¼‰
RESEND_API_KEY=re_xxxxxxxxxxxx
```

### 3.3 ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ï¼ˆèªè¨¼ãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼‰

```typescript
// routes/auth.ts
import express from 'express';
import bcrypt from 'bcrypt';
import crypto from 'crypto';
import { db } from '../config/database';
import { sendVerificationEmail } from '../services/emailService';

const router = express.Router();

// è–¬å‰¤å¸«ç™»éŒ²
router.post('/register/pharmacist', async (req, res) => {
  try {
    const { 
      email, 
      password, 
      last_name, 
      first_name, 
      phone_number,
      address,
      pharmacist_license_number 
    } = req.body;
    
    // æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒã‚§ãƒƒã‚¯
    const existingUser = await db.query(
      'SELECT id FROM users WHERE email = $1',
      [email]
    );
    
    if (existingUser.rows.length > 0) {
      return res.status(400).json({ 
        error: 'ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™' 
      });
    }
    
    // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥åŒ–
    const hashedPassword = await bcrypt.hash(password, 10);
    
    // èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ
    const verificationToken = crypto.randomBytes(32).toString('hex');
    const tokenExpiresAt = new Date(Date.now() + 24 * 60 * 60 * 1000); // 24æ™‚é–“å¾Œ
    
    // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹
    await db.query('BEGIN');
    
    try {
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
      const userResult = await db.query(
        `INSERT INTO users 
         (email, password, user_type, email_verified, verification_token, verification_token_expires_at) 
         VALUES ($1, $2, $3, $4, $5, $6) 
         RETURNING id, email, user_type, created_at`,
        [email, hashedPassword, 'pharmacist', false, verificationToken, tokenExpiresAt]
      );
      
      const user = userResult.rows[0];
      
      // è–¬å‰¤å¸«ãƒ¬ã‚³ãƒ¼ãƒ‰ä½œæˆ
      await db.query(
        `INSERT INTO pharmacists 
         (user_id, last_name, first_name, phone_number, address, pharmacist_license_number) 
         VALUES ($1, $2, $3, $4, $5, $6)`,
        [user.id, last_name, first_name, phone_number, address, pharmacist_license_number]
      );
      
      await db.query('COMMIT');
      
      // èªè¨¼ãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆéåŒæœŸï¼‰
      const verificationUrl = `${process.env.FRONTEND_URL}/verify-email/${verificationToken}`;
      const userName = `${last_name} ${first_name}`;
      
      sendVerificationEmail(email, userName, verificationUrl)
        .catch(error => console.error('Email sending error:', error));
      
      res.status(201).json({
        message: 'Registration successful. Please verify your email.',
        user: {
          id: user.id,
          email: user.email,
          user_type: user.user_type,
          email_verified: false,
          created_at: user.created_at
        }
      });
      
    } catch (error) {
      await db.query('ROLLBACK');
      throw error;
    }
    
  } catch (error) {
    console.error('Registration error:', error);
    res.status(500).json({ 
      error: 'Registration failed',
      details: process.env.NODE_ENV === 'development' ? error.message : undefined
    });
  }
});

export default router;
```

### 3.4 ãƒ¡ãƒ¼ãƒ«èªè¨¼å‡¦ç†

```typescript
// routes/auth.ts
router.get('/verify-email/:token', async (req, res) => {
  try {
    const { token } = req.params;
    
    // ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼
    const result = await db.query(
      `SELECT id, email, user_type, verification_token_expires_at 
       FROM users 
       WHERE verification_token = $1 AND email_verified = FALSE`,
      [token]
    );
    
    if (result.rows.length === 0) {
      return res.status(400).json({ 
        error: 'ç„¡åŠ¹ãªèªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã§ã™ã€‚ã¾ãŸã¯æ—¢ã«èªè¨¼æ¸ˆã¿ã§ã™ã€‚',
        code: 'INVALID_TOKEN'
      });
    }
    
    const user = result.rows[0];
    
    // ãƒˆãƒ¼ã‚¯ãƒ³æœŸé™ãƒã‚§ãƒƒã‚¯
    const now = new Date();
    const expiresAt = new Date(user.verification_token_expires_at);
    
    if (now > expiresAt) {
      return res.status(400).json({ 
        error: 'èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã¾ã™ã€‚å†é€ä¿¡ã—ã¦ãã ã•ã„ã€‚',
        code: 'TOKEN_EXPIRED'
      });
    }
    
    // ãƒ¡ãƒ¼ãƒ«èªè¨¼å®Œäº†
    await db.query(
      `UPDATE users 
       SET email_verified = TRUE, 
           verification_token = NULL, 
           verification_token_expires_at = NULL,
           updated_at = CURRENT_TIMESTAMP
       WHERE id = $1`,
      [user.id]
    );
    
    res.json({
      success: true,
      message: 'ãƒ¡ãƒ¼ãƒ«èªè¨¼ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚',
      email: user.email,
      user_type: user.user_type
    });
    
  } catch (error) {
    console.error('Email verification error:', error);
    res.status(500).json({ 
      error: 'Verification failed',
      code: 'VERIFICATION_FAILED'
    });
  }
});
```

### 3.5 èªè¨¼ãƒ¡ãƒ¼ãƒ«å†é€ä¿¡

```typescript
// routes/auth.ts
import rateLimit from 'express-rate-limit';

// ãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼ˆ15åˆ†ã§3å›ã¾ã§ï¼‰
const resendLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15åˆ†
  max: 3,
  message: 'èªè¨¼ãƒ¡ãƒ¼ãƒ«ã®å†é€ä¿¡å›æ•°ãŒä¸Šé™ã«é”ã—ã¾ã—ãŸã€‚15åˆ†å¾Œã«å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚'
});

router.post('/resend-verification', resendLimiter, async (req, res) => {
  try {
    const { email } = req.body;
    
    if (!email) {
      return res.status(400).json({ 
        error: 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„' 
      });
    }
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢ï¼ˆæœªèªè¨¼ã®ã¿ï¼‰
    const result = await db.query(
      `SELECT u.id, u.email, u.user_type,
              COALESCE(ph.last_name || ' ' || ph.first_name, p.representative_last_name || ' ' || p.representative_first_name) as name
       FROM users u
       LEFT JOIN pharmacists ph ON u.id = ph.user_id AND u.user_type = 'pharmacist'
       LEFT JOIN pharmacies p ON u.id = p.user_id AND u.user_type = 'pharmacy'
       WHERE u.email = $1 AND u.email_verified = FALSE`,
      [email]
    );
    
    if (result.rows.length === 0) {
      // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ã€å­˜åœ¨ã—ãªã„ãƒ¡ãƒ¼ãƒ«ã§ã‚‚åŒã˜ãƒ¬ã‚¹ãƒãƒ³ã‚¹
      return res.json({ 
        message: 'èªè¨¼ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚ãƒ¡ãƒ¼ãƒ«ãƒœãƒƒã‚¯ã‚¹ã‚’ã”ç¢ºèªãã ã•ã„ã€‚' 
      });
    }
    
    const user = result.rows[0];
    
    // æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ
    const verificationToken = crypto.randomBytes(32).toString('hex');
    const tokenExpiresAt = new Date(Date.now() + 24 * 60 * 60 * 1000);
    
    // ãƒˆãƒ¼ã‚¯ãƒ³æ›´æ–°
    await db.query(
      `UPDATE users 
       SET verification_token = $1, 
           verification_token_expires_at = $2,
           updated_at = CURRENT_TIMESTAMP
       WHERE id = $3`,
      [verificationToken, tokenExpiresAt, user.id]
    );
    
    // èªè¨¼ãƒ¡ãƒ¼ãƒ«å†é€ä¿¡
    const verificationUrl = `${process.env.FRONTEND_URL}/verify-email/${verificationToken}`;
    await sendVerificationEmail(user.email, user.name, verificationUrl);
    
    res.json({ 
      message: 'èªè¨¼ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚ãƒ¡ãƒ¼ãƒ«ãƒœãƒƒã‚¯ã‚¹ã‚’ã”ç¢ºèªãã ã•ã„ã€‚' 
    });
    
  } catch (error) {
    console.error('Resend verification error:', error);
    res.status(500).json({ 
      error: 'èªè¨¼ãƒ¡ãƒ¼ãƒ«ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ' 
    });
  }
});
```

### 3.6 ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®èªè¨¼ãƒã‚§ãƒƒã‚¯

```typescript
// routes/auth.ts
router.post('/login', async (req, res) => {
  try {
    const { email, password } = req.body;
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢
    const result = await db.query(
      'SELECT id, email, password, user_type, email_verified, is_active FROM users WHERE email = $1',
      [email]
    );
    
    if (result.rows.length === 0) {
      return res.status(401).json({ 
        error: 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“' 
      });
    }
    
    const user = result.rows[0];
    
    // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª
    const validPassword = await bcrypt.compare(password, user.password);
    
    if (!validPassword) {
      return res.status(401).json({ 
        error: 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“' 
      });
    }
    
    // ãƒ¡ãƒ¼ãƒ«èªè¨¼ãƒã‚§ãƒƒã‚¯
    if (!user.email_verified) {
      return res.status(403).json({ 
        error: 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒèªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ¡ãƒ¼ãƒ«ãƒœãƒƒã‚¯ã‚¹ã‚’ã”ç¢ºèªãã ã•ã„ã€‚',
        code: 'EMAIL_NOT_VERIFIED',
        email: user.email
      });
    }
    
    // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåœæ­¢ãƒã‚§ãƒƒã‚¯
    if (!user.is_active) {
      return res.status(403).json({ 
        error: 'ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯åœæ­¢ã•ã‚Œã¦ã„ã¾ã™ã€‚ã‚µãƒãƒ¼ãƒˆã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚',
        code: 'ACCOUNT_SUSPENDED'
      });
    }
    
    // JWTãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ
    const token = jwt.sign(
      { 
        id: user.id, 
        email: user.email, 
        user_type: user.user_type 
      },
      process.env.JWT_SECRET,
      { expiresIn: process.env.JWT_EXPIRES_IN || '24h' }
    );
    
    // æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³æ—¥æ™‚æ›´æ–°
    await db.query(
      'UPDATE users SET last_login_at = CURRENT_TIMESTAMP WHERE id = $1',
      [user.id]
    );
    
    res.json({
      success: true,
      token,
      user: {
        id: user.id,
        email: user.email,
        user_type: user.user_type
      }
    });
    
  } catch (error) {
    console.error('Login error:', error);
    res.status(500).json({ error: 'Login failed' });
  }
});
```

---

## 4. ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§

### 4.1 ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆResendä½¿ç”¨ä¾‹ï¼‰

```typescript
// services/emailService.ts
import { Resend } from 'resend';

const resend = new Resend(process.env.RESEND_API_KEY);

const FROM_EMAIL = process.env.FROM_EMAIL || 'noreply@example.com';
const FROM_NAME = process.env.FROM_NAME || 'è–¬å±€ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ';

// ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
function getEmailTemplate(title: string, content: string): string {
  return `
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${title}</title>
  <style>
    body {
      font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
      line-height: 1.8;
      color: #333;
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
    }
    .container {
      max-width: 600px;
      margin: 20px auto;
      background-color: #ffffff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px 20px;
      text-align: center;
    }
    .header h1 {
      margin: 0;
      font-size: 24px;
      font-weight: 600;
    }
    .content {
      padding: 40px 30px;
    }
    .button {
      display: inline-block;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white !important;
      padding: 14px 35px;
      text-decoration: none;
      border-radius: 6px;
      font-weight: 600;
      margin: 20px 0;
      transition: transform 0.2s;
    }
    .button:hover {
      transform: translateY(-2px);
    }
    .footer {
      background-color: #f8f9fa;
      padding: 20px 30px;
      text-align: center;
      font-size: 13px;
      color: #6c757d;
      border-top: 1px solid #e9ecef;
    }
    .alert {
      background-color: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 15px;
      margin: 20px 0;
      border-radius: 4px;
    }
    .alert-danger {
      background-color: #f8d7da;
      border-left-color: #dc3545;
    }
    .alert-success {
      background-color: #d4edda;
      border-left-color: #28a745;
    }
    .info-box {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
    }
    .url-box {
      background-color: #f8f9fa;
      padding: 12px;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      word-break: break-all;
      font-size: 13px;
      color: #495057;
      margin: 15px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ¥ è–¬å±€ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
    </div>
    <div class="content">
      ${content}
    </div>
    <div class="footer">
      <p>ã“ã®ãƒ¡ãƒ¼ãƒ«ã¯è‡ªå‹•é€ä¿¡ã•ã‚Œã¦ã„ã¾ã™ã€‚è¿”ä¿¡ã—ãªã„ã§ãã ã•ã„ã€‚</p>
      <p>ãŠå•ã„åˆã‚ã›: <a href="mailto:support@example.com">support@example.com</a></p>
      <p>&copy; 2026 è–¬å±€ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ . All rights reserved.</p>
    </div>
  </div>
</body>
</html>
  `;
}

// 1. ãƒ¡ãƒ¼ãƒ«èªè¨¼
export async function sendVerificationEmail(
  to: string,
  userName: string,
  verificationUrl: string
): Promise<void> {
  const content = `
    <p>${userName} æ§˜</p>
    
    <p>è–¬å±€ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã«ã”ç™»éŒ²ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚</p>
    
    <p>ä»¥ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
    
    <div style="text-align: center;">
      <a href="${verificationUrl}" class="button">
        ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç¢ºèªã™ã‚‹
      </a>
    </div>
    
    <p>ãƒœã‚¿ãƒ³ãŒæ©Ÿèƒ½ã—ãªã„å ´åˆã¯ã€ä»¥ä¸‹ã®URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãƒ–ãƒ©ã‚¦ã‚¶ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ï¼š</p>
    <div class="url-box">${verificationUrl}</div>
    
    <div class="alert">
      <strong>âš ï¸ é‡è¦</strong><br>
      ã“ã®ãƒªãƒ³ã‚¯ã®æœ‰åŠ¹æœŸé™ã¯24æ™‚é–“ã§ã™ã€‚<br>
      æœŸé™ãŒåˆ‡ã‚ŒãŸå ´åˆã¯ã€å†åº¦èªè¨¼ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¦ãã ã•ã„ã€‚
    </div>
    
    <p style="color: #6c757d; font-size: 14px; margin-top: 30px;">
      ã“ã®ãƒ¡ãƒ¼ãƒ«ã«å¿ƒå½“ãŸã‚ŠãŒãªã„å ´åˆã¯ã€ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚’ç„¡è¦–ã—ã¦ãã ã•ã„ã€‚
    </p>
  `;
  
  await resend.emails.send({
    from: `${FROM_NAME} <${FROM_EMAIL}>`,
    to,
    subject: 'ã€è–¬å±€ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã€‘ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ç¢ºèª',
    html: getEmailTemplate('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ç¢ºèª', content)
  });
}

// 2. æ–°è¦æ±‚äººæŠ•ç¨¿é€šçŸ¥ï¼ˆè–¬å±€â†’ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ï¼‰
export async function sendJobPostingNotification(
  pharmacyName: string,
  jobTitle: string,
  adminEmail: string
): Promise<void> {
  const content = `
    <p>ç®¡ç†è€…æ§˜</p>
    
    <p>æ–°ã—ã„æ±‚äººãŒæŠ•ç¨¿ã•ã‚Œã¾ã—ãŸã€‚</p>
    
    <div class="info-box">
      <strong>è–¬å±€å:</strong> ${pharmacyName}<br>
      <strong>æ±‚äººã‚¿ã‚¤ãƒˆãƒ«:</strong> ${jobTitle}
    </div>
    
    <div style="text-align: center;">
      <a href="${process.env.FRONTEND_URL}/admin/job-postings" class="button">
        æ±‚äººã‚’ç¢ºèªã™ã‚‹
      </a>
    </div>
  `;
  
  await resend.emails.send({
    from: `${FROM_NAME} <${FROM_EMAIL}>`,
    to: adminEmail,
    subject: 'ã€ç®¡ç†è€…é€šçŸ¥ã€‘æ–°ã—ã„æ±‚äººãŒæŠ•ç¨¿ã•ã‚Œã¾ã—ãŸ',
    html: getEmailTemplate('æ–°è¦æ±‚äººæŠ•ç¨¿', content)
  });
}

// 3. å¿œå‹Ÿé€šçŸ¥ï¼ˆè–¬å‰¤å¸«â†’è–¬å±€ï¼‰
export async function sendApplicationNotification(
  to: string,
  pharmacyName: string,
  jobTitle: string,
  applicantName: string
): Promise<void> {
  const content = `
    <p>${pharmacyName} æ§˜</p>
    
    <p>æ±‚äººã€Œ${jobTitle}ã€ã«æ–°ã—ã„å¿œå‹ŸãŒã‚ã‚Šã¾ã—ãŸã€‚</p>
    
    <div class="info-box">
      <strong>å¿œå‹Ÿè€…:</strong> ${applicantName}
    </div>
    
    <p>å¿œå‹Ÿè€…ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¦ãã ã•ã„ã€‚</p>
    
    <div style="text-align: center;">
      <a href="${process.env.FRONTEND_URL}/pharmacy/applications" class="button">
        å¿œå‹Ÿã‚’ç¢ºèªã™ã‚‹
      </a>
    </div>
  `;
  
  await resend.emails.send({
    from: `${FROM_NAME} <${FROM_EMAIL}>`,
    to,
    subject: `ã€è–¬å±€ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã€‘æ–°ã—ã„å¿œå‹ŸãŒã‚ã‚Šã¾ã—ãŸ - ${jobTitle}`,
    html: getEmailTemplate('æ–°ã—ã„å¿œå‹Ÿ', content)
  });
}

// 4. ã‚ªãƒ•ã‚¡ãƒ¼é€šçŸ¥ï¼ˆè–¬å±€â†’è–¬å‰¤å¸«ï¼‰
export async function sendOfferNotification(
  to: string,
  pharmacistName: string,
  pharmacyName: string,
  jobTitle: string
): Promise<void> {
  const content = `
    <p>${pharmacistName} æ§˜</p>
    
    <p>${pharmacyName}ã‹ã‚‰æ­£å¼ãªã‚ªãƒ•ã‚¡ãƒ¼ãŒå±Šãã¾ã—ãŸã€‚</p>
    
    <div class="info-box">
      <strong>æ±‚äºº:</strong> ${jobTitle}<br>
      <strong>è–¬å±€:</strong> ${pharmacyName}
    </div>
    
    <p>å¥‘ç´„å†…å®¹ã‚’ç¢ºèªã—ã¦ã€æ‰¿èªã¾ãŸã¯è¾é€€ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
    
    <div style="text-align: center;">
      <a href="${process.env.FRONTEND_URL}/pharmacist/applications" class="button">
        ã‚ªãƒ•ã‚¡ãƒ¼ã‚’ç¢ºèªã™ã‚‹
      </a>
    </div>
  `;
  
  await resend.emails.send({
    from: `${FROM_NAME} <${FROM_EMAIL}>`,
    to,
    subject: `ã€è–¬å±€ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã€‘${pharmacyName}ã‹ã‚‰æ­£å¼ã‚ªãƒ•ã‚¡ãƒ¼ãŒå±Šãã¾ã—ãŸ`,
    html: getEmailTemplate('æ­£å¼ã‚ªãƒ•ã‚¡ãƒ¼', content)
  });
}

// 5. å¥‘ç´„æˆç«‹é€šçŸ¥ï¼ˆåŒæ–¹ï¼‰
export async function sendContractCreatedNotification(
  to: string,
  userName: string,
  userType: 'pharmacy' | 'pharmacist',
  pharmacyName: string,
  pharmacistName: string,
  contractDetails: {
    initialWorkDate: string;
    workDays: number;
    dailyWage: number;
    totalCompensation: number;
    platformFee: number;
    paymentDeadline: string;
  }
): Promise<void> {
  const isPharma = userType === 'pharmacy';
  
  const content = `
    <p>${userName} æ§˜</p>
    
    <div class="alert-success">
      <strong>ğŸ‰ å¥‘ç´„ãŒæˆç«‹ã—ã¾ã—ãŸï¼</strong>
    </div>
    
    <p>ä»¥ä¸‹ã®å¥‘ç´„ãŒæˆç«‹ã—ã¾ã—ãŸã€‚</p>
    
    <div class="info-box">
      <strong>è–¬å±€:</strong> ${pharmacyName}<br>
      <strong>è–¬å‰¤å¸«:</strong> ${pharmacistName}<br>
      <strong>åˆå›å‡ºå‹¤æ—¥:</strong> ${contractDetails.initialWorkDate}<br>
      <strong>å‹¤å‹™æ—¥æ•°:</strong> ${contractDetails.workDays}æ—¥<br>
      <strong>æ—¥çµ¦:</strong> ${contractDetails.dailyWage.toLocaleString()}å††<br>
      <strong>å ±é…¬ç·é¡:</strong> ${contractDetails.totalCompensation.toLocaleString()}å††
    </div>
    
    ${isPharma ? `
    <div class="alert">
      <strong>âš ï¸ é‡è¦: æ‰‹æ•°æ–™ã®ãŠæ”¯æ‰•ã„ã«ã¤ã„ã¦</strong><br><br>
      <strong>ãŠæ”¯æ‰•ã„é‡‘é¡:</strong> ${contractDetails.platformFee.toLocaleString()}å††ï¼ˆå ±é…¬ç·é¡ã®40%ï¼‰<br>
      <strong>ãŠæ”¯æ‰•ã„æœŸé™:</strong> ${contractDetails.paymentDeadline}<br><br>
      æœŸé™ã¾ã§ã«ãŠæ”¯æ‰•ã„ãŒãªã„å ´åˆã€å¥‘ç´„ã¯è‡ªå‹•çš„ã«ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã™ã€‚
    </div>
    
    <div style="text-align: center;">
      <a href="${process.env.FRONTEND_URL}/pharmacy/contracts" class="button">
        è«‹æ±‚æ›¸ã‚’ç¢ºèªã™ã‚‹
      </a>
    </div>
    ` : `
    <div class="alert">
      <strong>ğŸ“‹ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—</strong><br><br>
      è–¬å±€ãŒæ‰‹æ•°æ–™ã‚’æ”¯æ‰•ã„ã€é‹å–¶ãŒç¢ºèªã—ãŸå¾Œã€<br>
      è–¬å±€ã®é€£çµ¡å…ˆãŒé–‹ç¤ºã•ã‚Œã¾ã™ã€‚<br><br>
      ãã®å¾Œã€è–¬å±€ã¨ç›´æ¥é€£çµ¡ã‚’å–ã‚Šã€<br>
      è©³ç´°ãªå‹¤å‹™ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’èª¿æ•´ã—ã¦ãã ã•ã„ã€‚
    </div>
    
    <div style="text-align: center;">
      <a href="${process.env.FRONTEND_URL}/pharmacist/contracts" class="button">
        å¥‘ç´„è©³ç´°ã‚’ç¢ºèªã™ã‚‹
      </a>
    </div>
    `}
  `;
  
  await resend.emails.send({
    from: `${FROM_NAME} <${FROM_EMAIL}>`,
    to,
    subject: 'ã€è–¬å±€ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã€‘å¥‘ç´„ãŒæˆç«‹ã—ã¾ã—ãŸ',
    html: getEmailTemplate('å¥‘ç´„æˆç«‹', content)
  });
}

// 6. æ”¯æ‰•ã„æœŸé™ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ï¼ˆè–¬å±€ï¼‰
export async function sendPaymentReminderNotification(
  to: string,
  pharmacyName: string,
  contractId: string,
  amount: number,
  deadline: string,
  daysRemaining: number
): Promise<void> {
  const isUrgent = daysRemaining <= 1;
  
  const content = `
    <p>${pharmacyName} æ§˜</p>
    
    <div class="${isUrgent ? 'alert-danger' : 'alert'}">
      <strong>${isUrgent ? 'ğŸš¨ ç·Šæ€¥' : 'âš ï¸ ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼'}: æ‰‹æ•°æ–™ã®ãŠæ”¯æ‰•ã„æœŸé™ãŒè¿‘ã¥ã„ã¦ã„ã¾ã™</strong>
    </div>
    
    <p>ä»¥ä¸‹ã®å¥‘ç´„ã®æ‰‹æ•°æ–™æ”¯æ‰•ã„æœŸé™ãŒ ${daysRemaining === 0 ? 'æœ¬æ—¥' : `ã‚ã¨${daysRemaining}æ—¥`} ã§ã™ã€‚</p>
    
    <div class="info-box">
      <strong>å¥‘ç´„ID:</strong> ${contractId}<br>
      <strong>ãŠæ”¯æ‰•ã„é‡‘é¡:</strong> ${amount.toLocaleString()}å††<br>
      <strong>ãŠæ”¯æ‰•ã„æœŸé™:</strong> ${deadline}
    </div>
    
    <div class="alert-danger">
      <strong>âš ï¸ é‡è¦</strong><br>
      æœŸé™ã¾ã§ã«ãŠæ”¯æ‰•ã„ãŒãªã„å ´åˆã€å¥‘ç´„ã¯è‡ªå‹•çš„ã«ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã€<br>
      ãƒšãƒŠãƒ«ãƒ†ã‚£ãŒé©ç”¨ã•ã‚Œã¾ã™ã€‚
    </div>
    
    <div style="text-align: center;">
      <a href="${process.env.FRONTEND_URL}/pharmacy/payments" class="button">
        ãŠæ”¯æ‰•ã„æ‰‹ç¶šãã¸
      </a>
    </div>
  `;
  
  await resend.emails.send({
    from: `${FROM_NAME} <${FROM_EMAIL}>`,
    to,
    subject: `ã€é‡è¦ã€‘æ‰‹æ•°æ–™ã®ãŠæ”¯æ‰•ã„æœŸé™ãŒ${daysRemaining === 0 ? 'æœ¬æ—¥' : `ã‚ã¨${daysRemaining}æ—¥`}ã§ã™`,
    html: getEmailTemplate('æ”¯æ‰•ã„æœŸé™ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼', content)
  });
}

// 7. æ”¯æ‰•ã„ç¢ºèªå®Œäº†é€šçŸ¥ï¼ˆåŒæ–¹ï¼‰
export async function sendPaymentConfirmedNotification(
  to: string,
  userName: string,
  userType: 'pharmacy' | 'pharmacist',
  pharmacyName: string,
  pharmacistName: string,
  contactInfo: {
    name: string;
    phone: string;
    email: string;
    address?: string;
  }
): Promise<void> {
  const isPharma = userType === 'pharmacy';
  
  const content = `
    <p>${userName} æ§˜</p>
    
    <div class="alert-success">
      <strong>âœ… æ‰‹æ•°æ–™ã®æ”¯æ‰•ã„ãŒç¢ºèªã•ã‚Œã¾ã—ãŸ</strong>
    </div>
    
    <p>${isPharma ? 'è–¬å‰¤å¸«' : 'è–¬å±€'}ã®é€£çµ¡å…ˆã‚’é–‹ç¤ºã„ãŸã—ã¾ã™ã€‚</p>
    
    <div class="info-box">
      <strong>${isPharma ? 'è–¬å‰¤å¸«' : 'è–¬å±€'}:</strong> ${isPharma ? pharmacistName : pharmacyName}<br>
      <strong>é›»è©±ç•ªå·:</strong> ${contactInfo.phone}<br>
      <strong>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹:</strong> ${contactInfo.email}
      ${contactInfo.address ? `<br><strong>ä½æ‰€:</strong> ${contactInfo.address}` : ''}
    </div>
    
    <div class="alert">
      <strong>ğŸ“ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—</strong><br><br>
      ç›´æ¥é€£çµ¡ã‚’å–ã‚Šã€è©³ç´°ãªå‹¤å‹™ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆå‹¤å‹™æ›œæ—¥ã€å‹¤å‹™æ™‚é–“ãªã©ï¼‰ã‚’<br>
      èª¿æ•´ã—ã¦ãã ã•ã„ã€‚
    </div>
    
    <div style="text-align: center;">
      <a href="${process.env.FRONTEND_URL}/${userType}/contracts" class="button">
        å¥‘ç´„è©³ç´°ã‚’ç¢ºèªã™ã‚‹
      </a>
    </div>
  `;
  
  await resend.emails.send({
    from: `${FROM_NAME} <${FROM_EMAIL}>`,
    to,
    subject: 'ã€è–¬å±€ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã€‘é€£çµ¡å…ˆã‚’é–‹ç¤ºã—ã¾ã—ãŸ',
    html: getEmailTemplate('é€£çµ¡å…ˆé–‹ç¤º', content)
  });
}

// 8. å¥‘ç´„ã‚­ãƒ£ãƒ³ã‚»ãƒ«é€šçŸ¥ï¼ˆåŒæ–¹ï¼‰
export async function sendContractCancelledNotification(
  to: string,
  userName: string,
  reason: string,
  contractId: string
): Promise<void> {
  const content = `
    <p>${userName} æ§˜</p>
    
    <div class="alert-danger">
      <strong>âŒ å¥‘ç´„ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ</strong>
    </div>
    
    <p>ä»¥ä¸‹ã®å¥‘ç´„ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚</p>
    
    <div class="info-box">
      <strong>å¥‘ç´„ID:</strong> ${contractId}<br>
      <strong>ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç†ç”±:</strong> ${reason}
    </div>
    
    <p>ã”ä¸æ˜ãªç‚¹ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€ã‚µãƒãƒ¼ãƒˆã¾ã§ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚</p>
  `;
  
  await resend.emails.send({
    from: `${FROM_NAME} <${FROM_EMAIL}>`,
    to,
    subject: 'ã€è–¬å±€ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã€‘å¥‘ç´„ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ',
    html: getEmailTemplate('å¥‘ç´„ã‚­ãƒ£ãƒ³ã‚»ãƒ«', content)
  });
}

// 9. ãƒšãƒŠãƒ«ãƒ†ã‚£é©ç”¨é€šçŸ¥ï¼ˆè–¬å±€ï¼‰
export async function sendPenaltyNotification(
  to: string,
  pharmacyName: string,
  penaltyType: string,
  reason: string,
  unpaidAmount: number
): Promise<void> {
  const content = `
    <p>${pharmacyName} æ§˜</p>
    
    <div class="alert-danger">
      <strong>âš ï¸ ãƒšãƒŠãƒ«ãƒ†ã‚£ãŒé©ç”¨ã•ã‚Œã¾ã—ãŸ</strong>
    </div>
    
    <p>æ‰‹æ•°æ–™ã®æœªæ‰•ã„ã«ã‚ˆã‚Šã€ä»¥ä¸‹ã®ãƒšãƒŠãƒ«ãƒ†ã‚£ãŒé©ç”¨ã•ã‚Œã¾ã—ãŸã€‚</p>
    
    <div class="info-box">
      <strong>ãƒšãƒŠãƒ«ãƒ†ã‚£ç¨®é¡:</strong> ${penaltyType}<br>
      <strong>ç†ç”±:</strong> ${reason}<br>
      <strong>æœªæ‰•ã„é‡‘é¡:</strong> ${unpaidAmount.toLocaleString()}å††
    </div>
    
    <div class="alert">
      <strong>ç¾åœ¨ã®åˆ¶é™</strong><br>
      âŒ æ–°è¦æ±‚äººæŠ•ç¨¿ãŒåœæ­¢ã•ã‚Œã¾ã—ãŸ<br>
      âŒ æ—¢å­˜ã®æ±‚äººãŒä¸€æ™‚åœæ­¢ã•ã‚Œã¾ã—ãŸ<br>
      âŒ è–¬å‰¤å¸«ã¸ã®é€£çµ¡ãŒåˆ¶é™ã•ã‚Œã¾ã—ãŸ
    </div>
    
    <p><strong>ãƒšãƒŠãƒ«ãƒ†ã‚£ã®è§£é™¤æ–¹æ³•:</strong></p>
    <ol>
      <li>æœªæ‰•ã„ã®æ‰‹æ•°æ–™ã‚’ãŠæ”¯æ‰•ã„ãã ã•ã„</li>
      <li>ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰è§£é™¤ç”³è«‹ã‚’è¡Œã£ã¦ãã ã•ã„</li>
      <li>é‹å–¶ã«ã‚ˆã‚‹å¯©æŸ»å¾Œã€è§£é™¤ã•ã‚Œã¾ã™</li>
    </ol>
    
    <div class="alert-danger">
      <strong>âš ï¸ é‡è¦ãªæ³¨æ„äº‹é …</strong><br>
      ã“ã‚Œã¯1å›ç›®ã®ãƒšãƒŠãƒ«ãƒ†ã‚£ã§ã™ã€‚<br>
      2å›ç›®ã®æœªæ‰•ã„ã§ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒæ°¸ä¹…åœæ­¢ã•ã‚Œã¾ã™ã€‚
    </div>
    
    <div style="text-align: center;">
      <a href="${process.env.FRONTEND_URL}/pharmacy/penalties" class="button">
        ãƒšãƒŠãƒ«ãƒ†ã‚£è©³ç´°ã‚’ç¢ºèª
      </a>
    </div>
  `;
  
  await resend.emails.send({
    from: `${FROM_NAME} <${FROM_EMAIL}>`,
    to,
    subject: 'ã€é‡è¦ã€‘ãƒšãƒŠãƒ«ãƒ†ã‚£ãŒé©ç”¨ã•ã‚Œã¾ã—ãŸ',
    html: getEmailTemplate('ãƒšãƒŠãƒ«ãƒ†ã‚£é©ç”¨', content)
  });
}

// 10. ãƒšãƒŠãƒ«ãƒ†ã‚£è§£é™¤é€šçŸ¥ï¼ˆè–¬å±€ï¼‰
export async function sendPenaltyResolvedNotification(
  to: string,
  pharmacyName: string
): Promise<void> {
  const content = `
    <p>${pharmacyName} æ§˜</p>
    
    <div class="alert-success">
      <strong>âœ… ãƒšãƒŠãƒ«ãƒ†ã‚£ãŒè§£é™¤ã•ã‚Œã¾ã—ãŸ</strong>
    </div>
    
    <p>æ‰‹æ•°æ–™ã®ãŠæ”¯æ‰•ã„ã‚’ç¢ºèªã„ãŸã—ã¾ã—ãŸã€‚<br>
    ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚’è§£é™¤ã—ã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å¾©æ—§ã„ãŸã—ã¾ã—ãŸã€‚</p>
    
    <div class="info-box">
      <strong>å¾©æ—§ã—ãŸæ©Ÿèƒ½:</strong><br>
      âœ… æ–°è¦æ±‚äººæŠ•ç¨¿ãŒå¯èƒ½ã«ãªã‚Šã¾ã—ãŸ<br>
      âœ… æ—¢å­˜æ±‚äººãŒå†é–‹ã•ã‚Œã¾ã—ãŸ<br>
      âœ… é€šå¸¸æ©Ÿèƒ½ãŒã”åˆ©ç”¨å¯èƒ½ã§ã™
    </div>
    
    <div class="alert">
      <strong>âš ï¸ ä»Šå¾Œã®ã”æ³¨æ„</strong><br>
      ã“ã‚Œã¯1å›ç›®ã®ãƒšãƒŠãƒ«ãƒ†ã‚£ã§ã—ãŸã€‚<br>
      2å›ç›®ã®æœªæ‰•ã„ã§ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒæ°¸ä¹…åœæ­¢ã•ã‚Œã¾ã™ã€‚<br>
      æ”¯æ‰•ã„æœŸé™ã‚’å³å®ˆã„ãŸã ãã¾ã™ã‚ˆã†ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚
    </div>
    
    <div style="text-align: center;">
      <a href="${process.env.FRONTEND_URL}/pharmacy/dashboard" class="button">
        ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸
      </a>
    </div>
  `;
  
  await resend.emails.send({
    from: `${FROM_NAME} <${FROM_EMAIL}>`,
    to,
    subject: 'ã€è–¬å±€ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã€‘ãƒšãƒŠãƒ«ãƒ†ã‚£ãŒè§£é™¤ã•ã‚Œã¾ã—ãŸ',
    html: getEmailTemplate('ãƒšãƒŠãƒ«ãƒ†ã‚£è§£é™¤', content)
  });
}

// 11. è¨¼æ˜æ›¸æ‰¿èªé€šçŸ¥ï¼ˆè–¬å‰¤å¸«ï¼‰
export async function sendCertificateApprovedNotification(
  to: string,
  pharmacistName: string
): Promise<void> {
  const content = `
    <p>${pharmacistName} æ§˜</p>
    
    <div class="alert-success">
      <strong>âœ… è³‡æ ¼è¨¼æ˜æ›¸ãŒæ‰¿èªã•ã‚Œã¾ã—ãŸ</strong>
    </div>
    
    <p>è–¬å‰¤å¸«å…è¨±è¨¼ã¨ä¿é™ºè–¬å‰¤å¸«ç™»éŒ²ç¥¨ã®ç¢ºèªãŒå®Œäº†ã—ã¾ã—ãŸã€‚</p>
    
    <p>æ±‚äººã¸ã®å¿œå‹ŸãŒå¯èƒ½ã«ãªã‚Šã¾ã—ãŸã€‚<br>
    æ¡ä»¶ã«åˆã£ãŸæ±‚äººã‚’æ¢ã—ã¦ã€ãœã²å¿œå‹Ÿã—ã¦ãã ã•ã„ã€‚</p>
    
    <div style="text-align: center;">
      <a href="${process.env.FRONTEND_URL}/pharmacist/job-postings" class="button">
        æ±‚äººã‚’æ¢ã™
      </a>
    </div>
  `;
  
  await resend.emails.send({
    from: `${FROM_NAME} <${FROM_EMAIL}>`,
    to,
    subject: 'ã€è–¬å±€ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã€‘è³‡æ ¼è¨¼æ˜æ›¸ãŒæ‰¿èªã•ã‚Œã¾ã—ãŸ',
    html: getEmailTemplate('è¨¼æ˜æ›¸æ‰¿èª', content)
  });
}

// 12. è¨¼æ˜æ›¸å·®ã—æˆ»ã—é€šçŸ¥ï¼ˆè–¬å‰¤å¸«ï¼‰
export async function sendCertificateRejectedNotification(
  to: string,
  pharmacistName: string,
  reason: string
): Promise<void> {
  const content = `
    <p>${pharmacistName} æ§˜</p>
    
    <div class="alert-danger">
      <strong>âš ï¸ è³‡æ ¼è¨¼æ˜æ›¸ãŒå·®ã—æˆ»ã•ã‚Œã¾ã—ãŸ</strong>
    </div>
    
    <p>ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ãŒã€æå‡ºã„ãŸã ã„ãŸè³‡æ ¼è¨¼æ˜æ›¸ã«ä¸å‚™ãŒã‚ã‚Šã¾ã—ãŸã€‚</p>
    
    <div class="info-box">
      <strong>å·®ã—æˆ»ã—ç†ç”±:</strong><br>
      ${reason}
    </div>
    
    <p>ãŠæ‰‹æ•°ã§ã™ãŒã€ä¿®æ­£ã®ä¸Šã€å†åº¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚</p>
    
    <div style="text-align: center;">
      <a href="${process.env.FRONTEND_URL}/pharmacist/profile/certificates" class="button">
        è¨¼æ˜æ›¸ã‚’å†ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      </a>
    </div>
  `;
  
  await resend.emails.send({
    from: `${FROM_NAME} <${FROM_EMAIL}>`,
    to,
    subject: 'ã€è–¬å±€ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã€‘è³‡æ ¼è¨¼æ˜æ›¸ã®å†æå‡ºã‚’ãŠé¡˜ã„ã—ã¾ã™',
    html: getEmailTemplate('è¨¼æ˜æ›¸å·®ã—æˆ»ã—', content)
  });
}

// 13. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ
export async function sendPasswordResetEmail(
  to: string,
  userName: string,
  resetUrl: string
): Promise<void> {
  const content = `
    <p>${userName} æ§˜</p>
    
    <p>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸã€‚</p>
    
    <p>ä»¥ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚</p>
    
    <div style="text-align: center;">
      <a href="${resetUrl}" class="button">
        ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ
      </a>
    </div>
    
    <p>ãƒœã‚¿ãƒ³ãŒæ©Ÿèƒ½ã—ãªã„å ´åˆã¯ã€ä»¥ä¸‹ã®URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãƒ–ãƒ©ã‚¦ã‚¶ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ï¼š</p>
    <div class="url-box">${resetUrl}</div>
    
    <div class="alert">
      <strong>âš ï¸ é‡è¦</strong><br>
      ã“ã®ãƒªãƒ³ã‚¯ã®æœ‰åŠ¹æœŸé™ã¯1æ™‚é–“ã§ã™ã€‚<br>
      æœŸé™ãŒåˆ‡ã‚ŒãŸå ´åˆã¯ã€å†åº¦ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã¦ãã ã•ã„ã€‚
    </div>
    
    <p style="color: #6c757d; font-size: 14px; margin-top: 30px;">
      ã“ã®ãƒ¡ãƒ¼ãƒ«ã«å¿ƒå½“ãŸã‚ŠãŒãªã„å ´åˆã¯ã€ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚’ç„¡è¦–ã—ã¦ãã ã•ã„ã€‚<br>
      ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯å¤‰æ›´ã•ã‚Œã¾ã›ã‚“ã€‚
    </p>
  `;
  
  await resend.emails.send({
    from: `${FROM_NAME} <${FROM_EMAIL}>`,
    to,
    subject: 'ã€è–¬å±€ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã€‘ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆã®ã”æ¡ˆå†…',
    html: getEmailTemplate('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ', content)
  });
}

// 14. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€šçŸ¥
export async function sendMessageNotification(
  to: string,
  userName: string,
  senderName: string,
  messagePreview: string,
  applicationUrl: string
): Promise<void> {
  const content = `
    <p>${userName} æ§˜</p>
    
    <p>${senderName}ã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå±Šãã¾ã—ãŸã€‚</p>
    
    <div class="info-box">
      <strong>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼:</strong><br>
      ${messagePreview}
    </div>
    
    <div style="text-align: center;">
      <a href="${applicationUrl}" class="button">
        ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèªã™ã‚‹
      </a>
    </div>
  `;
  
  await resend.emails.send({
    from: `${FROM_NAME} <${FROM_EMAIL}>`,
    to,
    subject: `ã€è–¬å±€ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã€‘${senderName}ã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå±Šãã¾ã—ãŸ`,
    html: getEmailTemplate('æ–°ç€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸', content)
  });
}

// 15. ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹é€šçŸ¥
export async function sendMaintenanceNotification(
  to: string,
  userName: string,
  startTime: string,
  endTime: string,
  description: string
): Promise<void> {
  const content = `
    <p>${userName} æ§˜</p>
    
    <p>ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã®ãŠçŸ¥ã‚‰ã›ã§ã™ã€‚</p>
    
    <div class="info-box">
      <strong>ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ—¥æ™‚:</strong><br>
      ${startTime} ã€œ ${endTime}<br><br>
      <strong>å†…å®¹:</strong><br>
      ${description}
    </div>
    
    <div class="alert">
      <strong>âš ï¸ ã”æ³¨æ„</strong><br>
      ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ä¸­ã¯ã‚·ã‚¹ãƒ†ãƒ ã‚’ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã›ã‚“ã€‚<br>
      ã”ä¸ä¾¿ã‚’ãŠã‹ã‘ã—ã¾ã™ãŒã€ã”ç†è§£ã¨ã”å”åŠ›ã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚
    </div>
  `;
  
  await resend.emails.send({
    from: `${FROM_NAME} <${FROM_EMAIL}>`,
    to,
    subject: 'ã€è–¬å±€ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã€‘ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã®ãŠçŸ¥ã‚‰ã›',
    html: getEmailTemplate('ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹é€šçŸ¥', content)
  });
}
```

---

## 5. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…

### 5.1 ç™»éŒ²å®Œäº†ç”»é¢

```tsx
// pages/RegisterSuccess.tsx
import { useLocation } from 'react-router-dom';

export default function RegisterSuccess() {
  const location = useLocation();
  const email = location.state?.email || '';

  return (
    <div className="max-w-md mx-auto mt-10 p-6 bg-white rounded-lg shadow-lg">
      <div className="text-center">
        <div className="text-6xl mb-4">âœ…</div>
        <h1 className="text-2xl font-bold mb-4">ç™»éŒ²å®Œäº†</h1>
        
        <p className="text-gray-600 mb-4">
          ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚
        </p>
        
        <div className="bg-blue-50 border border-blue-200 rounded p-4 mb-4">
          <p className="text-sm text-blue-800">
            <strong>{email}</strong> ã«é€ä¿¡ã•ã‚ŒãŸ<br />
            ç¢ºèªãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚
          </p>
        </div>
        
        <div className="bg-yellow-50 border border-yellow-200 rounded p-4 text-sm text-left">
          <p className="font-bold mb-2">ğŸ“§ ãƒ¡ãƒ¼ãƒ«ãŒå±Šã‹ãªã„å ´åˆ:</p>
          <ul className="list-disc list-inside space-y-1 text-gray-700">
            <li>è¿·æƒ‘ãƒ¡ãƒ¼ãƒ«ãƒ•ã‚©ãƒ«ãƒ€ã‚’ã”ç¢ºèªãã ã•ã„</li>
            <li>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒæ­£ã—ã„ã‹ã”ç¢ºèªãã ã•ã„</li>
            <li>ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†é€ä¿¡ã—ã¦ãã ã•ã„</li>
          </ul>
        </div>
        
        <button 
          onClick={() => window.location.href = '/resend-verification'}
          className="mt-4 text-blue-600 hover:underline"
        >
          ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’å†é€ä¿¡
        </button>
      </div>
    </div>
  );
}
```

### 5.2 ãƒ¡ãƒ¼ãƒ«èªè¨¼ç”»é¢

```tsx
// pages/VerifyEmail.tsx
import { useEffect, useState } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import axios from 'axios';

export default function VerifyEmail() {
  const { token } = useParams<{ token: string }>();
  const navigate = useNavigate();
  const [status, setStatus] = useState<'loading' | 'success' | 'error'>('loading');
  const [message, setMessage] = useState('');
  const [errorCode, setErrorCode] = useState('');

  useEffect(() => {
    const verifyEmail = async () => {
      try {
        const response = await axios.get(`/api/auth/verify-email/${token}`);
        
        setStatus('success');
        setMessage(response.data.message);
        
        // 3ç§’å¾Œã«ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
        setTimeout(() => {
          navigate('/login', { 
            state: { 
              message: 'ãƒ¡ãƒ¼ãƒ«èªè¨¼ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚' 
            } 
          });
        }, 3000);
        
      } catch (error: any) {
        setStatus('error');
        setMessage(error.response?.data?.error || 'Verification failed');
        setErrorCode(error.response?.data?.code || '');
      }
    };

    if (token) {
      verifyEmail();
    }
  }, [token, navigate]);

  return (
    <div className="max-w-md mx-auto mt-10 p-6 bg-white rounded-lg shadow-lg">
      {status === 'loading' && (
        <div className="text-center">
          <div className="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600 mx-auto mb-4"></div>
          <h2 className="text-xl font-bold mb-2">ãƒ¡ãƒ¼ãƒ«èªè¨¼ä¸­...</h2>
          <p className="text-gray-600">ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚</p>
        </div>
      )}
      
      {status === 'success' && (
        <div className="text-center">
          <div className="text-6xl mb-4">âœ…</div>
          <h2 className="text-2xl font-bold text-green-600 mb-2">
            ãƒ¡ãƒ¼ãƒ«èªè¨¼å®Œäº†
          </h2>
          <p className="text-gray-600 mb-4">{message}</p>
          <p className="text-sm text-gray-500">
            ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«ç§»å‹•ã—ã¾ã™...
          </p>
        </div>
      )}
      
      {status === 'error' && (
        <div className="text-center">
          <div className="text-6xl mb-4">âŒ</div>
          <h2 className="text-2xl font-bold text-red-600 mb-2">èªè¨¼å¤±æ•—</h2>
          <p className="text-gray-600 mb-4">{message}</p>
          
          {errorCode === 'TOKEN_EXPIRED' && (
            <button
              onClick={() => navigate('/resend-verification')}
              className="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700"
            >
              èªè¨¼ãƒ¡ãƒ¼ãƒ«ã‚’å†é€ä¿¡
            </button>
          )}
          
          <button
            onClick={() => navigate('/login')}
            className="mt-2 text-gray-600 hover:underline block"
          >
            ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸
          </button>
        </div>
      )}
    </div>
  );
}
```

### 5.3 èªè¨¼ãƒ¡ãƒ¼ãƒ«å†é€ä¿¡ç”»é¢

```tsx
// pages/ResendVerification.tsx
import { useState } from 'react';
import axios from 'axios';

export default function ResendVerification() {
  const [email, setEmail] = useState('');
  const [status, setStatus] = useState<'idle' | 'loading' | 'success' | 'error'>('idle');
  const [message, setMessage] = useState('');

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setStatus('loading');

    try {
      const response = await axios.post('/api/auth/resend-verification', { email });
      setStatus('success');
      setMessage(response.data.message);
    } catch (error: any) {
      setStatus('error');
      setMessage(error.response?.data?.error || 'é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  };

  return (
    <div className="max-w-md mx-auto mt-10 p-6 bg-white rounded-lg shadow-lg">
      <h1 className="text-2xl font-bold mb-6">èªè¨¼ãƒ¡ãƒ¼ãƒ«ã‚’å†é€ä¿¡</h1>
      
      {status === 'success' ? (
        <div className="bg-green-50 border border-green-200 rounded p-4">
          <p className="text-green-800">âœ… {message}</p>
        </div>
      ) : (
        <form onSubmit={handleSubmit}>
          <div className="mb-4">
            <label className="block text-gray-700 mb-2">
              ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
            </label>
            <input
              type="email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              required
              className="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-600"
              placeholder="your-email@example.com"
            />
          </div>

          {status === 'error' && (
            <div className="mb-4 bg-red-50 border border-red-200 rounded p-3 text-red-800">
              {message}
            </div>
          )}

          <button
            type="submit"
            disabled={status === 'loading'}
            className="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 disabled:bg-gray-400"
          >
            {status === 'loading' ? 'é€ä¿¡ä¸­...' : 'å†é€ä¿¡ã™ã‚‹'}
          </button>
        </form>
      )}
    </div>
  );
}
```

---

## 6. ãƒ¡ãƒ¼ãƒ«ã‚µãƒ¼ãƒ“ã‚¹é¸æŠã‚¬ã‚¤ãƒ‰

### 6.1 æ¨å¥¨ã‚µãƒ¼ãƒ“ã‚¹æ¯”è¼ƒ

| ã‚µãƒ¼ãƒ“ã‚¹ | ç„¡æ–™æ  | ä¾¡æ ¼ | ä¿¡é ¼æ€§ | è¨­å®šé›£æ˜“åº¦ | ãŠã™ã™ã‚åº¦ |
|---------|-------|------|--------|-----------|----------|
| **Resend** | 100é€š/æ—¥ | $20/æœˆã€œ | â­â­â­â­â­ | â­ ç°¡å˜ | â˜…â˜…â˜…â˜…â˜… |
| SendGrid | 100é€š/æ—¥ | $15/æœˆã€œ | â­â­â­â­â­ | â­â­ æ™®é€š | â˜…â˜…â˜…â˜…â˜† |
| AWS SES | ãªã— | $0.10/1000é€š | â­â­â­â­â­ | â­â­â­ é›£ | â˜…â˜…â˜…â˜†â˜† |
| Mailgun | 100é€š/æ—¥ | $35/æœˆã€œ | â­â­â­â­ | â­â­ æ™®é€š | â˜…â˜…â˜…â˜†â˜† |
| Nodemailer | - | SMTPæ¬¡ç¬¬ | â­â­â­ | â­â­â­â­ é›£ | â˜…â˜…â˜†â˜†â˜† |

### 6.2 Resendï¼ˆæ¨å¥¨ï¼‰

```bash
npm install resend
```

```typescript
import { Resend } from 'resend';

const resend = new Resend(process.env.RESEND_API_KEY);

await resend.emails.send({
  from: 'noreply@yourdomain.com',
  to: 'user@example.com',
  subject: 'Hello',
  html: '<p>Hello World</p>'
});
```

**ãƒ¡ãƒªãƒƒãƒˆ:**
- é–‹ç™ºè€…ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼
- ã‚·ãƒ³ãƒ—ãƒ«ãªAPI
- React Emailå¯¾å¿œ
- ç„¡æ–™æ ãŒååˆ†

### 6.3 SendGrid

```bash
npm install @sendgrid/mail
```

```typescript
import sgMail from '@sendgrid/mail';

sgMail.setApiKey(process.env.SENDGRID_API_KEY);

await sgMail.send({
  to: 'user@example.com',
  from: 'noreply@yourdomain.com',
  subject: 'Hello',
  html: '<p>Hello World</p>'
});
```

**ãƒ¡ãƒªãƒƒãƒˆ:**
- æ¥­ç•Œæ¨™æº–
- é«˜ã„ä¿¡é ¼æ€§
- è±Šå¯Œãªæ©Ÿèƒ½

---

## 7. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–

### 7.1 ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ

```typescript
// âœ… æ¨å¥¨: crypto.randomBytes
import crypto from 'crypto';
const token = crypto.randomBytes(32).toString('hex');

// âŒ éæ¨å¥¨: Math.random()ï¼ˆäºˆæ¸¬å¯èƒ½ï¼‰
const token = Math.random().toString(36);
```

### 7.2 ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™

```typescript
// ãƒ¡ãƒ¼ãƒ«èªè¨¼: 24æ™‚é–“
const emailVerificationExpiry = new Date(Date.now() + 24 * 60 * 60 * 1000);

// ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ: 1æ™‚é–“ï¼ˆã‚ˆã‚ŠçŸ­ãï¼‰
const passwordResetExpiry = new Date(Date.now() + 60 * 60 * 1000);
```

### 7.3 ãƒ¬ãƒ¼ãƒˆåˆ¶é™

```typescript
import rateLimit from 'express-rate-limit';

const emailLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15åˆ†
  max: 3, // æœ€å¤§3å›
  message: 'Too many requests. Please try again later.'
});

router.post('/resend-verification', emailLimiter, handler);
```

### 7.4 HTTPSå¿…é ˆ

```typescript
// productionç’°å¢ƒã§ã¯HTTPSã‚’å¼·åˆ¶
if (process.env.NODE_ENV === 'production' && req.protocol !== 'https') {
  return res.redirect('https://' + req.get('host') + req.url);
}
```

---

## 8. å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### 8.1 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹

```
â–¡ usersãƒ†ãƒ¼ãƒ–ãƒ«ã«èªè¨¼ã‚«ãƒ©ãƒ ã‚’è¿½åŠ 
  â–¡ email_verified (boolean)
  â–¡ verification_token (varchar)
  â–¡ verification_token_expires_at (timestamp)
  â–¡ reset_password_token (varchar)
  â–¡ reset_password_token_expires_at (timestamp)

â–¡ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆ
  â–¡ verification_token
  â–¡ reset_password_token
```

### 8.2 ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰

```
â–¡ ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚µãƒ¼ãƒ“ã‚¹ã‚’é¸æŠãƒ»è¨­å®š
  â–¡ Resend / SendGrid / ãã®ä»–
  â–¡ ç’°å¢ƒå¤‰æ•°è¨­å®š

â–¡ èªè¨¼ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å®Ÿè£…
  â–¡ POST /auth/register/* (ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆãƒ»ãƒ¡ãƒ¼ãƒ«é€ä¿¡)
  â–¡ GET /auth/verify-email/:token
  â–¡ POST /auth/resend-verification

â–¡ ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®èªè¨¼ãƒã‚§ãƒƒã‚¯
  â–¡ email_verifiedãŒfalseãªã‚‰ãƒ­ã‚°ã‚¤ãƒ³æ‹’å¦

â–¡ ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆ
  â–¡ ãƒ¡ãƒ¼ãƒ«èªè¨¼
  â–¡ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ
  â–¡ ãã®ä»–æ¥­å‹™ãƒ¡ãƒ¼ãƒ«ï¼ˆ15ç¨®é¡ï¼‰

â–¡ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
  â–¡ ãƒˆãƒ¼ã‚¯ãƒ³æœŸé™åˆ‡ã‚Œ
  â–¡ ç„¡åŠ¹ãªãƒˆãƒ¼ã‚¯ãƒ³
  â–¡ ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—

â–¡ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–
  â–¡ crypto.randomBytesä½¿ç”¨
  â–¡ ãƒ¬ãƒ¼ãƒˆåˆ¶é™å®Ÿè£…
  â–¡ HTTPSå¼·åˆ¶
```

### 8.3 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰

```
â–¡ ç™»éŒ²å®Œäº†ç”»é¢
  â–¡ ãƒ¡ãƒ¼ãƒ«é€ä¿¡æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  â–¡ å†é€ä¿¡ãƒªãƒ³ã‚¯

â–¡ ãƒ¡ãƒ¼ãƒ«èªè¨¼ç”»é¢
  â–¡ ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
  â–¡ æˆåŠŸæ™‚ã®è‡ªå‹•ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
  â–¡ ã‚¨ãƒ©ãƒ¼æ™‚ã®å†é€ä¿¡ãƒœã‚¿ãƒ³

â–¡ èªè¨¼ãƒ¡ãƒ¼ãƒ«å†é€ä¿¡ç”»é¢
  â–¡ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ 
  â–¡ ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚¨ãƒ©ãƒ¼è¡¨ç¤º

â–¡ ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢
  â–¡ æœªèªè¨¼ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  â–¡ å†é€ä¿¡ãƒªãƒ³ã‚¯
```

### 8.4 ãƒ†ã‚¹ãƒˆ

```
â–¡ ãƒ¡ãƒ¼ãƒ«èªè¨¼ãƒ•ãƒ­ãƒ¼
  â–¡ æ­£å¸¸ãªèªè¨¼
  â–¡ ãƒˆãƒ¼ã‚¯ãƒ³æœŸé™åˆ‡ã‚Œ
  â–¡ ç„¡åŠ¹ãªãƒˆãƒ¼ã‚¯ãƒ³
  â–¡ æ—¢ã«èªè¨¼æ¸ˆã¿

â–¡ ãƒ¡ãƒ¼ãƒ«å†é€ä¿¡
  â–¡ æ­£å¸¸ãªå†é€ä¿¡
  â–¡ ãƒ¬ãƒ¼ãƒˆåˆ¶é™
  â–¡ å­˜åœ¨ã—ãªã„ãƒ¡ãƒ¼ãƒ«

â–¡ ãƒ­ã‚°ã‚¤ãƒ³
  â–¡ æœªèªè¨¼ã§ã®ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œ
  â–¡ èªè¨¼å¾Œã®ãƒ­ã‚°ã‚¤ãƒ³
```

---

## 9. ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### 9.1 ãƒ¡ãƒ¼ãƒ«ãŒå±Šã‹ãªã„

**åŸå› ã¨å¯¾ç­–:**
```
1. SPF/DKIM/DMARCè¨­å®šãŒä¸é©åˆ‡
   â†’ DNSãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’æ­£ã—ãè¨­å®š

2. è¿·æƒ‘ãƒ¡ãƒ¼ãƒ«ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
   â†’ ä¿¡é ¼æ€§ã®é«˜ã„ãƒ¡ãƒ¼ãƒ«ã‚µãƒ¼ãƒ“ã‚¹ä½¿ç”¨
   â†’ From ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç‹¬è‡ªãƒ‰ãƒ¡ã‚¤ãƒ³ã«

3. ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚µãƒ¼ãƒ“ã‚¹ã®åˆ¶é™
   â†’ ç„¡æ–™æ ã‚’è¶…ãˆã¦ã„ãªã„ã‹ç¢ºèª
   â†’ APIã‚­ãƒ¼ãŒæ­£ã—ã„ã‹ç¢ºèª
```

### 9.2 ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹

**åŸå› ã¨å¯¾ç­–:**
```
1. ãƒˆãƒ¼ã‚¯ãƒ³ã®æœŸé™åˆ‡ã‚Œ
   â†’ å†é€ä¿¡æ©Ÿèƒ½ã‚’æ¡ˆå†…

2. ãƒˆãƒ¼ã‚¯ãƒ³ãŒæ—¢ã«ä½¿ç”¨æ¸ˆã¿
   â†’ email_verifiedãŒtrueã‹ç¢ºèª
   â†’ æ—¢ã«èªè¨¼æ¸ˆã¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º

3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å•é¡Œ
   â†’ ãƒˆãƒ¼ã‚¯ãƒ³ãŒæ­£ã—ãä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
```

---

ä»¥ä¸Šã€ãƒ¡ãƒ¼ãƒ«èªè¨¼ãƒ»ãƒ¡ãƒ¼ãƒ«æ©Ÿèƒ½è¨­è¨ˆæ›¸
