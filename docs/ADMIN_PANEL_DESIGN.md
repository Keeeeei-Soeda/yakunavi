# 管理者パネル統合設計書

## 📋 目次

1. [概要](#概要)
2. [システムアーキテクチャ](#システムアーキテクチャ)
3. [認証・権限管理](#認証権限管理)
4. [ダッシュボード](#ダッシュボード)
5. [薬剤師管理](#薬剤師管理)
6. [薬局管理](#薬局管理)
7. [契約・案件管理](#契約案件管理)
8. [書類管理](#書類管理)
9. [支払い管理](#支払い管理)
10. [統計・レポート](#統計レポート)
11. [データエクスポート](#データエクスポート)
12. [監査ログ](#監査ログ)
13. [API設計](#api設計)
14. [データベース設計](#データベース設計)

---

## 1. 概要

### 1.1 目的

薬局管理システムの運営管理者が、システム全体を統合的に管理・監視するためのWebベースの管理パネルです。

### 1.2 主要機能

- **薬剤師管理**: 登録情報、資格証明書、プロフィールの一元管理
- **薬局管理**: 登録情報、連絡先、求人投稿の一元管理
- **契約管理**: 契約成立から完了までの全ステータス管理
- **書類管理**: 請求書、労働条件通知書の生成・紐付け・確認
- **支払い管理**: 支払い報告の確認、承認、ステータス管理
- **統計・分析**: ユーザー数、契約数、売上などの統計情報

### 1.3 設計原則

- **既存システムとの整合性**: 現在のデータベーススキーマ、API設計と完全に整合
- **一元管理**: 薬局側・薬剤師側の情報を統合的に管理
- **リアルタイム更新**: ステータス変更を即座に反映
- **監査可能性**: すべての操作をログに記録

---

## 2. システムアーキテクチャ

### 2.1 技術スタック

```
フロントエンド:
- Next.js 14+ (App Router)
- TypeScript
- Tailwind CSS
- React Query (データフェッチング)

バックエンド:
- Express.js (既存API)
- Prisma ORM (既存)
- PostgreSQL (既存)

認証:
- JWT (既存システムと統合)
- Role-based Access Control (RBAC)
```

### 2.2 ルーティング構造

```
/admin
├── /login                    # 管理者ログイン
├── /dashboard                # ダッシュボード
├── /pharmacists              # 薬剤師管理
│   ├── /                     # 薬剤師一覧
│   ├── /[id]                 # 薬剤師詳細
│   └── /[id]/certificates    # 資格証明書管理
├── /pharmacies               # 薬局管理
│   ├── /                     # 薬局一覧
│   └── /[id]                 # 薬局詳細
├── /contracts                # 契約管理
│   ├── /                     # 契約一覧
│   └── /[id]                 # 契約詳細
│       ├── /documents        # 書類管理
│       └── /payment         # 支払い管理
├── /payments                 # 支払い管理
│   ├── /                     # 支払い一覧
│   └── /[id]                 # 支払い詳細
├── /reports                  # 統計・レポート
└── /audit-log                # 監査ログ
```

---

## 3. 認証・権限管理

### 3.1 管理者アカウント

#### データベース設計

```prisma
model Admin {
  id        BigInt   @id @default(autoincrement())
  email     String   @unique @db.VarChar(255)
  password  String   @map("password_hash") @db.VarChar(255)
  name      String   @db.VarChar(100)
  role      String   @default("admin") @db.VarChar(20) // 'admin', 'super_admin'
  isActive  Boolean  @default(true) @map("is_active")
  lastLoginAt DateTime? @map("last_login_at")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  auditLogs AuditLog[]
  
  @@map("admins")
}
```

#### ロール定義

- **admin**: 通常の管理者（薬剤師・薬局管理、支払い確認）
- **super_admin**: スーパー管理者（システム設定、アカウント管理）

### 3.2 認証フロー

```
1. 管理者ログイン画面 (/admin/login)
   ↓
2. メールアドレス・パスワード入力
   ↓
3. JWTトークン発行（有効期限: 24時間）
   ↓
4. ダッシュボードへリダイレクト
```

### 3.3 権限チェック

すべての管理画面で、以下のミドルウェアで権限をチェック：

```typescript
// 管理者認証ミドルウェア
authenticateAdmin(req, res, next) {
  // JWTトークン検証
  // 管理者ロール確認
  // アクティブ状態確認
}
```

---

## 4. ダッシュボード

### 4.1 サマリーカード

```
┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────┐
│   登録薬局数         │  │   登録薬剤師数       │  │   アクティブ求人     │
│     125件           │  │     1,520件         │  │      48件           │
│   (+5件 今月)       │  │   (+120件 今月)     │  │   (+12件 今週)      │
└─────────────────────┘  └─────────────────────┘  └─────────────────────┘

┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────┐
│   契約成立数         │  │   未確認証明書       │  │   未確認支払い       │
│     38件            │  │   🔴  15件          │  │   🔴  8件           │
│   （今月）          │  │   要対応             │  │   要対応             │
└─────────────────────┘  └─────────────────────┘  └─────────────────────┘
```

### 4.2 要対応項目

```
⚠️ 要対応項目

┌────────────────────────────────────────────┐
│ 🚨 証明書確認待ち：15件 ［確認する］          │
│   最古：7日前（薬剤師ID: 125）                │
├────────────────────────────────────────────┤
│ 🚨 支払い確認待ち：8件 ［確認する］           │
│   最古：3日前（請求書ID: INV-001）            │
├────────────────────────────────────────────┤
│ ⚠️ ペナルティ解除申請：3件 ［確認する］        │
│   最古：2日前（ペナルティID: #002）           │
└────────────────────────────────────────────┘
```

### 4.3 最近のアクティビティ

```
最近のアクティビティ（直近10件）

├─ 2026/01/28 14:30 - 支払い確認完了（請求書ID: INV-003）
├─ 2026/01/28 13:15 - 新規薬局登録：さくら薬局 駅前店
├─ 2026/01/28 12:00 - 証明書承認（薬剤師ID: 156）
├─ 2026/01/28 11:45 - 契約成立（契約ID: #1234）
└─ 「すべて見る」
```

### 4.4 統計グラフ

- **新規登録ユーザー数**（月次・週次）
- **契約成立数**（月次・週次）
- **売上（手数料）**（月次・週次）
- **応募数・成約率**（月次）

---

## 5. 薬剤師管理

### 5.1 薬剤師一覧

#### 検索・フィルター機能

```
【薬剤師管理】

検索: [氏名、メール、電話番号、免許番号で検索...] [🔍]

フィルター:
├─ ステータス: [すべて ▼] [アクティブ] [停止中] [確認待ち]
├─ 証明書: [すべて ▼] [確認済み] [未確認] [差し戻し]
├─ 登録日: [期間選択] [今日] [今週] [今月] [カスタム]
└─ 都道府県: [すべて ▼] [東京都] [大阪府] ...
```

#### テーブル表示

```
┌────────────────────────────────────────────────────────────────────────────┐
│ ID │氏名 │メール │電話番号 │住所 │免許番号 │証明書 │登録日 │ステータス │アクション│
├────────────────────────────────────────────────────────────────────────────┤
│ 1  │田中一郎│phar...│090-1111│東京都│12345678│✅確認済│2026/01/20│✅アクティブ│👁 詳細│
│ 2  │鈴木美咲│phar...│080-2222│大阪府│23456789│⏳未確認│2026/01/25│⏳確認待ち│👁 詳細│
│ 3  │佐藤健太│phar...│070-3333│神奈川│34567890│❌差戻│2026/01/26│⚠️再提出待│👁 詳細│
└────────────────────────────────────────────────────────────────────────────┘

[CSV出力] [Excel出力] [ページネーション: ← 前へ] 1 / 50 [次へ →]
```

#### 表示項目

- **ID**: 薬剤師ID（内部ID）
- **氏名**: 姓 + 名
- **メール**: メールアドレス（最初の数文字 + ...）
- **電話番号**: 電話番号
- **住所**: 都道府県 + 市区町村（詳細は非表示）
- **免許番号**: 薬剤師免許番号
- **証明書**: ステータス（確認済み/未確認/差し戻し）
- **登録日**: アカウント作成日
- **ステータス**: アカウント状態（アクティブ/停止中/確認待ち）

### 5.2 薬剤師詳細

#### 基本情報セクション

```
【薬剤師詳細】ID: #00001

┌─────────────────────────────────────────────────────────┐
│ 基本情報                                                 │
├─────────────────────────────────────────────────────────┤
│ 薬剤師ID: #00001                                         │
│ 氏名: 田中 一郎                                          │
│ メールアドレス: pharmacist1@test.com                    │
│ 電話番号: 090-1111-2222                                 │
│ 住所: 東京都新宿区新宿1-2-3                              │
│ 生年月日: 1990年5月15日（34歳）                          │
│ 最寄駅: 新宿駅                                           │
│ 登録日: 2026年1月20日 10:30                              │
│ 最終ログイン: 2026年1月28日 14:20                        │
│ ステータス: ✅ アクティブ                                │
│                                                          │
│ [アカウント停止] [メール送信] [編集]                      │
└─────────────────────────────────────────────────────────┘
```

#### 資格情報セクション

```
┌─────────────────────────────────────────────────────────┐
│ 資格情報                                                 │
├─────────────────────────────────────────────────────────┤
│ 出身大学: 東京薬科大学                                   │
│ 卒業年: 2012年                                           │
│ 薬剤師免許番号: 12345678                                 │
│ 免許取得年: 2012年                                       │
│ 認定薬剤師資格: がん薬物療法認定薬剤師、糖尿病薬物療法認定薬剤師│
│ その他の資格: 登録販売者                                  │
│                                                          │
│ [資格情報を編集]                                         │
└─────────────────────────────────────────────────────────┘
```

#### 経歴情報セクション

```
┌─────────────────────────────────────────────────────────┐
│ 経歴情報                                                 │
├─────────────────────────────────────────────────────────┤
│ 勤務経験年数: 12年3ヶ月                                  │
│ 勤務経験業態: 調剤薬局、ドラッグストア                   │
│ 主な業務経験: 調剤業務、服薬指導、在庫管理、在宅医療      │
│ 得意な診療科: 循環器科、糖尿病、がん領域                  │
│ 薬歴システム: Pharnes（ファーネス）、Musubi（むすび）     │
│ 特記事項: 英語対応可                                     │
│                                                          │
│ [経歴情報を編集]                                         │
└─────────────────────────────────────────────────────────┘
```

#### 資格証明書セクション

```
┌─────────────────────────────────────────────────────────┐
│ 資格証明書                                               │
├─────────────────────────────────────────────────────────┤
│ ステータス: ✅ 確認済み                                  │
│ 確認日: 2026年1月21日 14:30                              │
│ 確認者: 管理者 A                                         │
│                                                          │
│ 📄 薬剤師免許証                                           │
│   ファイル名: 薬剤師免許証.pdf                            │
│   アップロード日: 2026年1月20日 10:35                     │
│   ファイルサイズ: 2.5MB                                   │
│   [PDFを表示] [PDFをダウンロード]                         │
│                                                          │
│ 📄 保険薬剤師登録票                                       │
│   ファイル名: 保険薬剤師登録票.pdf                        │
│   アップロード日: 2026年1月20日 10:36                     │
│   ファイルサイズ: 1.8MB                                   │
│   [PDFを表示] [PDFをダウンロード]                         │
│                                                          │
│ [証明書を再確認] [差し戻す]                               │
└─────────────────────────────────────────────────────────┘
```

#### 統計情報セクション

```
┌─────────────────────────────────────────────────────────┐
│ 統計情報                                                 │
├─────────────────────────────────────────────────────────┤
│ 応募数: 5件                                              │
│ 契約成立数: 3件                                          │
│ 総稼働日数: 90日                                         │
│ 平均日給: 22,000円                                       │
│                                                          │
│ [応募履歴を見る] [契約履歴を見る]                         │
└─────────────────────────────────────────────────────────┘
```

#### 自己紹介セクション

```
┌─────────────────────────────────────────────────────────┐
│ 自己紹介・アピールポイント                               │
├─────────────────────────────────────────────────────────┤
│ 12年間の調剤薬局での経験を活かし、患者様に寄り添った      │
│ 服薬指導を心がけています。特に循環器科と糖尿病領域に      │
│ 強みがあり、在宅医療にも対応可能です。                    │
│ チームワークを大切にし、効率的な業務処理を心がけています。│
└─────────────────────────────────────────────────────────┘
```

### 5.3 資格証明書管理

#### 証明書確認待ち一覧

```
【資格証明書確認】

タブ: [未確認(15)] [確認済み] [差し戻し] [すべて]

⚠️ 未確認の証明書が15件あります

ソート: [提出日 ▼] [経過日数 ▼] [薬剤師ID ▼]

┌────────────────────────────────────────────────────────────┐
│ 薬剤師ID │氏名 │免許番号 │提出日 │経過日数 │ステータス │アクション│
├────────────────────────────────────────────────────────────┤
│ 123   │山田太郎│123456│2026/01/25│2日│⏳未確認│👁 確認│
│ 124   │佐藤花子│234567│2026/01/24│3日│⏳未確認│👁 確認│
│ 125   │鈴木次郎│345678│2026/01/20│🔴7日│⏳未確認│👁 確認│
└────────────────────────────────────────────────────────────┘
```

#### 証明書確認画面

```
【証明書確認詳細】

薬剤師情報:
├─ 薬剤師ID: #00123
├─ 氏名: 山田 太郎
├─ メール: pharmacist123@test.com
├─ 電話: 090-1234-5678
└─ 提出日: 2026/01/25 14:30

📄 薬剤師免許証
┌──────────────────────────────────────┐
│ [PDF表示エリア（埋め込みビューアー）]    │
│                                        │
│ [PDFをダウンロード] [拡大表示] [全画面] │
└──────────────────────────────────────┘

確認チェックリスト:
☐ 免許証が鮮明に確認できる
☐ 氏名が登録情報と一致している
☐ 免許番号が確認できる
☐ 有効期限内である

📄 保険薬剤師登録票
┌──────────────────────────────────────┐
│ [PDF表示エリア（埋め込みビューアー）]    │
│                                        │
│ [PDFをダウンロード] [拡大表示] [全画面] │
└──────────────────────────────────────┘

確認チェックリスト:
☐ 登録票が鮮明に確認できる
☐ 氏名が登録情報と一致している
☐ 登録番号が確認できる

コメント（任意）:
┌──────────────────────────────────────┐
│ [テキストエリア]                         │
│ 確認完了。すべて問題ありません。          │
└──────────────────────────────────────┘

アクション:
[✅ 承認する] [❌ 差し戻す] [⏸ 保留] [キャンセル]
```

#### 承認後の自動処理

1. `pharmacists.verificationStatus` を `verified` に更新
2. `pharmacists.verifiedAt` に現在日時を記録
3. `certificates.verificationStatus` を `verified` に更新
4. 薬剤師にメール通知「資格証明書が承認されました。応募可能です」
5. 監査ログに記録

---

## 6. 薬局管理

### 6.1 薬局一覧

#### 検索・フィルター機能

```
【薬局管理】

検索: [薬局名、代表者名、メール、電話番号で検索...] [🔍]

フィルター:
├─ ステータス: [すべて ▼] [アクティブ] [停止中]
├─ 都道府県: [すべて ▼] [東京都] [大阪府] ...
├─ 登録日: [期間選択] [今日] [今週] [今月] [カスタム]
└─ ペナルティ: [すべて ▼] [ペナルティあり] [なし]
```

#### テーブル表示

```
┌────────────────────────────────────────────────────────────────────────────┐
│ ID │薬局名 │代表者 │メール │電話番号 │住所 │登録日 │ステータス │ペナルティ │アクション│
├───────────────────────────────────────────────────────────────────────────┤
│ 1  │羽曳野薬局│山田太郎│phar...│072-1234│大阪府│2026/01/20│✅アクティブ│なし│👁 詳細│
│ 2  │梅田薬局│佐藤花子│phar...│06-1234│東京都│2026/01/18│⚠️停止中│あり│👁 詳細│
└────────────────────────────────────────────────────────────────────────────┘

[CSV出力] [Excel出力] [ページネーション: ← 前へ] 1 / 25 [次へ →]
```

### 6.2 薬局詳細

#### 基本情報セクション

```
【薬局詳細】ID: #00001

┌─────────────────────────────────────────────────────────┐
│ 基本情報                                                 │
├─────────────────────────────────────────────────────────┤
│ 薬局ID: #00001                                           │
│ 薬局名: 羽曳野薬局                                        │
│ 代表者: 山田 太郎                                         │
│ メールアドレス: pharmacy1@test.com                      │
│ 電話番号: 072-1234-5678                                  │
│ FAX番号: 072-1234-5679                                   │
│ 都道府県: 大阪府                                          │
│ 住所: 大阪府羽曳野市羽曳野1-2-3                           │
│ 最寄駅: 古市駅（近鉄南大阪線）                             │
│ 設立日: 2010年4月1日                                     │
│ 登録日: 2026年1月20日 10:00                              │
│ 最終ログイン: 2026年1月28日 15:30                        │
│ ステータス: ✅ アクティブ                                 │
│                                                          │
│ [アカウント停止] [メール送信] [編集]                      │
└─────────────────────────────────────────────────────────┘
```

#### 薬局情報セクション

```
┌─────────────────────────────────────────────────────────┐
│ 薬局情報                                                 │
├─────────────────────────────────────────────────────────┤
│ 1日の処方箋枚数: 80枚                                     │
│ スタッフ数: 5名                                          │
│ 営業時間: 9:00 - 18:00                                   │
│                                                          │
│ 薬局の紹介:                                              │
│ 地域密着型の調剤薬局です。患者様第一をモットーに、        │
│ 丁寧な服薬指導を心がけています。在宅医療にも対応して      │
│ おり、地域の皆様の健康をサポートしています。              │
│                                                          │
│ 強み:                                                    │
│ ・丁寧な服薬指導                                          │
│ ・在宅医療対応                                            │
│ ・地域密着型のサービス                                    │
│ ・アットホームな雰囲気                                    │
│                                                          │
│ 設備・システム:                                          │
│ ・電子薬歴システム（Musubi）導入済み                      │
│ ・在宅医療支援システム完備                                │
│                                                          │
│ [薬局情報を編集]                                         │
└─────────────────────────────────────────────────────────┘
```

#### 統計情報セクション

```
┌─────────────────────────────────────────────────────────┐
│ 統計情報                                                 │
├─────────────────────────────────────────────────────────┤
│ 投稿求人数: 5件（アクティブ: 2件）                        │
│ 契約成立数: 3件                                          │
│ 支払い総額: 1,500,000円                                  │
│ ペナルティ履歴: なし                                     │
│                                                          │
│ [求人一覧を見る] [契約一覧を見る] [支払い履歴を見る]       │
└─────────────────────────────────────────────────────────┘
```

#### ペナルティ情報セクション（該当する場合）

```
┌─────────────────────────────────────────────────────────┐
│ ペナルティ情報                                           │
├─────────────────────────────────────────────────────────┤
│ ステータス: 🔴 ペナルティ適用中                           │
│ 適用日: 2026年2月10日                                    │
│ 理由: 手数料未払い                                       │
│ 未払額: 120,000円                                        │
│ 解除申請: あり（申請日: 2026年2月12日）                   │
│                                                          │
│ [ペナルティ詳細を見る] [解除申請を確認]                   │
└─────────────────────────────────────────────────────────┘
```

---

## 7. 契約・案件管理

### 7.1 契約一覧

#### 検索・フィルター機能

```
【契約管理】

検索: [契約ID、薬局名、薬剤師名で検索...] [🔍]

フィルター:
├─ ステータス: [すべて ▼] [承認待ち] [支払い待ち] [契約成立] [完了] [キャンセル]
├─ 契約日: [期間選択] [今日] [今週] [今月] [カスタム]
└─ 薬局: [すべて ▼] [薬局名で選択]
```

#### テーブル表示

```
┌────────────────────────────────────────────────────────────────────────────┐
│ 契約ID │薬局 │薬剤師 │初回出勤日│日給 │日数│報酬総額│手数料│ステータス│アクション│
├────────────────────────────────────────────────────────────────────────────┤
│ #1234│羽曳野薬局│佐藤花子│2026/02/12│22,000│30日│660,000│264,000│✅契約成立│👁 詳細│
│ #1235│梅田薬局│山田太郎│2026/02/15│25,000│20日│500,000│200,000│⏳支払い待ち│👁 詳細│
└────────────────────────────────────────────────────────────────────────────┘

統計:
├─ 総契約数: 125件
├─ 契約成立: 98件
└─ 支払い待ち: 12件

[CSV出力] [Excel出力] [ページネーション: ← 前へ] 1 / 13 [次へ →]
```

### 7.2 契約詳細

#### 契約情報セクション

```
【契約詳細】契約ID: #1234

┌─────────────────────────────────────────────────────────┐
│ 契約情報                                                 │
├─────────────────────────────────────────────────────────┤
│ 契約ID: #1234                                            │
│ 契約日: 2026年1月27日 14:30                              │
│ ステータス: ✅ 契約成立（active）                         │
│ 初回出勤日: 2026年2月12日                                │
│ 契約期間: 2026年2月12日 〜 2026年3月14日（30日間）        │
│                                                          │
│ [ステータスを変更]                                        │
└─────────────────────────────────────────────────────────┘
```

#### 薬局情報セクション

```
┌─────────────────────────────────────────────────────────┐
│ 薬局情報                                                 │
├─────────────────────────────────────────────────────────┤
│ 薬局ID: #00001                                            │
│ 薬局名: 羽曳野薬局                                        │
│ 代表者: 山田 太郎                                         │
│ メール: pharmacy1@test.com                               │
│ 電話: 072-1234-5678                                      │
│ 住所: 大阪府羽曳野市羽曳野1-2-3                          │
│                                                          │
│ [薬局詳細を見る]                                          │
└─────────────────────────────────────────────────────────┘
```

#### 薬剤師情報セクション

```
┌─────────────────────────────────────────────────────────┐
│ 薬剤師情報                                               │
├─────────────────────────────────────────────────────────┤
│ 薬剤師ID: #00003                                          │
│ 氏名: 佐藤 花子                                           │
│ メール: pharmacist3@test.com                             │
│ 電話: 080-9876-5432                                      │
│ 住所: 東京都新宿区新宿2-3-4                              │
│                                                          │
│ [薬剤師詳細を見る]                                        │
└─────────────────────────────────────────────────────────┘
```

#### 報酬情報セクション

```
┌─────────────────────────────────────────────────────────┐
│ 報酬情報                                                 │
├─────────────────────────────────────────────────────────┤
│ 日給: 22,000円                                           │
│ 勤務日数: 30日                                           │
│ 報酬総額: 660,000円                                      │
│ 手数料（40%）: 264,000円                                 │
│ 勤務時間: 9:00～18:00（休憩1時間）                       │
│                                                          │
│ [報酬情報を編集]                                         │
└─────────────────────────────────────────────────────────┘
```

#### 支払い情報セクション

```
┌─────────────────────────────────────────────────────────┐
│ 支払い情報                                               │
├─────────────────────────────────────────────────────────┤
│ 支払いID: #00003                                          │
│ 支払期限: 2026年2月9日                                    │
│ 支払い報告日: 2026年2月8日 15:30                         │
│ 支払い確認日: 2026年2月8日 16:00                         │
│ ステータス: ✅ 確認済み                                   │
│                                                          │
│ [支払い詳細を見る]                                        │
└─────────────────────────────────────────────────────────┘
```

#### 書類セクション

```
┌─────────────────────────────────────────────────────────┐
│ 関連書類                                                 │
├─────────────────────────────────────────────────────────┤
│ 📄 労働条件通知書                                         │
│    生成日: 2026年1月27日 14:35                           │
│    ファイル名: labor_conditions_1234.pdf                 │
│    [PDFを表示] [PDFをダウンロード]                         │
│                                                          │
│ 📄 請求書                                                 │
│    生成日: 2026年1月27日 14:35                           │
│    ファイル名: invoice_1234.pdf                         │
│    [PDFを表示] [PDFをダウンロード]                         │
│                                                          │
│ [書類を再生成] [書類一覧を見る]                           │
└─────────────────────────────────────────────────────────┘
```

#### 応募・メッセージ履歴セクション

```
┌─────────────────────────────────────────────────────────┐
│ 応募・メッセージ履歴                                       │
├─────────────────────────────────────────────────────────┤
│ 応募ID: #0011                                             │
│ 応募日: 2026年1月20日 11:00                              │
│ 応募ステータス: accepted（承認済み）                       │
│                                                          │
│ メッセージ数: 12件                                        │
│ 最終メッセージ: 2026年1月27日 14:20                      │
│                                                          │
│ [応募詳細を見る] [メッセージ履歴を見る]                   │
└─────────────────────────────────────────────────────────┘
```

---

## 8. 書類管理

### 8.1 書類一覧

#### 検索・フィルター機能

```
【書類管理】

検索: [契約ID、薬局名、薬剤師名で検索...] [🔍]

フィルター:
├─ 書類種別: [すべて ▼] [労働条件通知書] [請求書] [契約書]
├─ 生成日: [期間選択] [今日] [今週] [今月] [カスタム]
└─ ステータス: [すべて ▼] [生成済み] [ダウンロード済み]
```

#### テーブル表示

```
┌────────────────────────────────────────────────────────────────────────────┐
│ 書類ID │契約ID │書類種別 │薬局 │薬剤師 │生成日 │ダウンロード │ファイルサイズ│アクション│
├────────────────────────────────────────────────────────────────────────────┤
│ 1  │#1234│労働条件通知書│羽曳野│佐藤花子│2026/01/27│✅薬局・薬剤師│2.5MB│👁 詳細│
│ 2  │#1234│請求書│羽曳野│佐藤花子│2026/01/27│✅薬局│1.8MB│👁 詳細│
└────────────────────────────────────────────────────────────────────────────┘
```

### 8.2 書類詳細

#### 書類情報セクション

```
【書類詳細】書類ID: #00001

┌─────────────────────────────────────────────────────────┐
│ 書類情報                                                 │
├─────────────────────────────────────────────────────────┤
│ 書類ID: #00001                                            │
│ 契約ID: #1234                                             │
│ 書類種別: 労働条件通知書                                  │
│ ファイル名: labor_conditions_1234.pdf                   │
│ ファイルサイズ: 2.5MB                                     │
│ 生成日: 2026年1月27日 14:35                              │
│                                                          │
│ ダウンロード状況:                                         │
│ ├─ 薬局: ✅ ダウンロード済み（2026/01/27 15:00）         │
│ └─ 薬剤師: ✅ ダウンロード済み（2026/01/28 10:30）       │
└─────────────────────────────────────────────────────────┘
```

#### PDF表示セクション

```
┌─────────────────────────────────────────────────────────┐
│ PDF表示                                                  │
├─────────────────────────────────────────────────────────┤
│ [PDF埋め込みビューアー]                                   │
│                                                          │
│ [PDFをダウンロード] [拡大表示] [全画面] [印刷]            │
└─────────────────────────────────────────────────────────┘
```

#### 関連情報セクション

```
┌─────────────────────────────────────────────────────────┐
│ 関連情報                                                 │
├─────────────────────────────────────────────────────────┤
│ 契約ID: #1234                                             │
│ 薬局: 羽曳野薬局（ID: #00001）                            │
│ 薬剤師: 佐藤 花子（ID: #00003）                           │
│                                                          │
│ [契約詳細を見る] [薬局詳細を見る] [薬剤師詳細を見る]       │
└─────────────────────────────────────────────────────────┘
```

### 8.3 書類の紐付け確認

#### 契約と書類の紐付け

```
契約ID: #1234 に関連する書類

├─ 📄 労働条件通知書（書類ID: #00001）
│   ├─ 生成日: 2026/01/27 14:35
│   ├─ ファイル: labor_conditions_1234.pdf
│   └─ ステータス: ✅ 生成済み
│
├─ 📄 請求書（書類ID: #00002）
│   ├─ 生成日: 2026/01/27 14:35
│   ├─ ファイル: invoice_1234.pdf
│   └─ ステータス: ✅ 生成済み
│
└─ 📄 契約書（書類ID: #00003）
    ├─ 生成日: 2026/01/27 14:40
    ├─ ファイル: contract_1234.pdf
    └─ ステータス: ✅ 生成済み
```

---

## 9. 支払い管理

### 9.1 支払い一覧

#### 検索・フィルター機能

```
【支払い管理】

タブ: [確認待ち(8)] [確認済み] [確認失敗] [すべて]

⚠️ 支払い確認待ちが8件あります

検索: [請求書番号、薬局名で検索...] [🔍]

フィルター:
├─ ステータス: [すべて ▼] [確認待ち] [確認済み] [確認失敗]
├─ 支払期限: [期間選択] [今日が期限] [期限超過] [カスタム]
└─ 薬局: [すべて ▼] [薬局名で選択]
```

#### テーブル表示

```
┌────────────────────────────────────────────────────────────────────────────┐
│ 請求書番号│薬局名│契約ID│請求額│支払期限│報告日│経過日数│ステータス│アクション│
├────────────────────────────────────────────────────────────────────────────┤
│ INV-001│羽曳野薬局│#1234│264,000│2026/02/09│2026/02/08│1日│⏳確認待ち│👁 確認│
│ INV-002│梅田薬局│#1235│200,000│2026/02/10│2026/02/09│1日│⏳確認待ち│👁 確認│
└────────────────────────────────────────────────────────────────────────────┘

統計:
├─ 確認待ち: 8件（合計: 2,100,000円）
├─ 本日が期限: 2件
└─ 今月の手数料収入: 8,600,000円

[CSV出力] [Excel出力] [ページネーション: ← 前へ] 1 / 5 [次へ →]
```

### 9.2 支払い詳細・確認

#### 支払い情報セクション

```
【支払い確認詳細】請求書番号: INV-001

┌─────────────────────────────────────────────────────────┐
│ 支払い情報                                               │
├─────────────────────────────────────────────────────────┤
│ 支払いID: #00003                                          │
│ 請求書番号: INV-001                                       │
│ 契約ID: #1234                                             │
│ 請求額: 264,000円                                        │
│ 支払期限: 2026年2月9日                                    │
│ 支払い報告日: 2026年2月8日 15:30                         │
│ ステータス: ⏳ 確認待ち                                   │
│                                                          │
│ [ステータスを変更]                                        │
└─────────────────────────────────────────────────────────┘
```

#### 薬局情報セクション

```
┌─────────────────────────────────────────────────────────┐
│ 薬局情報                                                 │
├─────────────────────────────────────────────────────────┤
│ 薬局ID: #00001                                            │
│ 薬局名: 羽曳野薬局                                        │
│ 代表者: 山田 太郎                                         │
│ メール: pharmacy1@test.com                               │
│ 電話: 072-1234-5678                                      │
│                                                          │
│ [薬局詳細を見る]                                          │
└─────────────────────────────────────────────────────────┘
```

#### 契約情報セクション

```
┌─────────────────────────────────────────────────────────┐
│ 契約情報                                                 │
├─────────────────────────────────────────────────────────┤
│ 契約ID: #1234                                             │
│ 薬剤師: 佐藤 花子                                         │
│ 初回出勤日: 2026年2月12日                                │
│ 報酬総額: 660,000円                                      │
│ 手数料（40%）: 264,000円                                 │
│                                                          │
│ [契約詳細を見る]                                          │
└─────────────────────────────────────────────────────────┘
```

#### 支払い報告内容セクション

```
┌─────────────────────────────────────────────────────────┐
│ 支払い報告内容                                           │
├─────────────────────────────────────────────────────────┤
│ 振込日: 2026年2月8日                                     │
│ 振込名義人: ヤマダタロウ                                 │
│ 振込金額: 264,000円                                      │
│ 報告日時: 2026年2月8日 15:30                             │
│                                                          │
│ 薬局からのメッセージ（任意）:                             │
│ 「本日入金いたしました。ご確認をお願いいたします。」      │
└─────────────────────────────────────────────────────────┘
```

#### 振込先情報セクション

```
┌─────────────────────────────────────────────────────────┐
│ 振込先情報                                               │
├─────────────────────────────────────────────────────────┤
│ 銀行: ◯◯銀行 ◯◯支店                                     │
│ 口座種別: 普通                                           │
│ 口座番号: 1234567                                        │
│ 口座名義: プラットフォーム運営株式会社                    │
└─────────────────────────────────────────────────────────┘
```

#### 入金確認セクション

```
┌─────────────────────────────────────────────────────────┐
│ 入金確認                                                 │
├─────────────────────────────────────────────────────────┤
│ 確認チェックリスト:                                       │
│ ☐ 銀行口座への入金を確認しました                          │
│ ☐ 振込名義人が一致しています                              │
│ ☐ 振込金額が正しい（264,000円）                           │
│                                                          │
│ 確認メモ（任意）:                                         │
│ ┌──────────────────────────────────────┐               │
│ │ [テキストエリア]                         │               │
│ │ 入金確認完了。金額・名義人ともに一致。  │               │
│ └──────────────────────────────────────┘               │
│                                                          │
│ ⚠️ 確認後、薬局と薬剤師の連絡先が相互に開示されます        │
│                                                          │
│ アクション:                                              │
│ [✅ 確認完了] [❌ 確認失敗] [⏸ 保留] [キャンセル]        │
└─────────────────────────────────────────────────────────┘
```

#### 関連書類セクション

```
┌─────────────────────────────────────────────────────────┐
│ 関連書類                                                 │
├─────────────────────────────────────────────────────────┤
│ 📄 請求書（書類ID: #00002）                               │
│    生成日: 2026年1月27日 14:35                           │
│    ファイル名: invoice_1234.pdf                         │
│    [PDFを表示] [PDFをダウンロード]                       │
│                                                          │
│ 📄 労働条件通知書（書類ID: #00001）                      │
│    生成日: 2026年1月27日 14:35                           │
│    ファイル名: labor_conditions_1234.pdf                │
│    [PDFを表示] [PDFをダウンロード]                       │
│                                                          │
│ [書類一覧を見る]                                          │
└─────────────────────────────────────────────────────────┘
```

### 9.3 承認後の自動処理

1. `payments.paymentStatus` を `confirmed` に更新
2. `payments.confirmedAt` に現在日時を記録
3. `contracts.status` を `active` に更新
4. `contracts.paymentConfirmedAt` に現在日時を記録
5. 薬局にメール通知「支払いが確認されました。薬剤師の連絡先を開示します」
6. 薬剤師にメール通知「薬局の手数料支払いが確認されました。連絡先を開示します」
7. 監査ログに記録

---

## 10. 統計・レポート

### 10.1 統計ダッシュボード

#### 期間選択

```
【統計・レポート】

期間選択: [過去30日 ▼] [過去7日] [過去90日] [今月] [今週] [カスタム]

[期間を選択] 2026年1月1日 〜 2026年1月31日
```

#### ユーザー統計

```
┌─────────────────────────────────────────────────────────┐
│ ユーザー統計                                             │
├─────────────────────────────────────────────────────────┤
│ 新規登録薬局数: 35件（+12% 前月比）                       │
│ 新規登録薬剤師数: 280件（+8% 前月比）                     │
│                                                          │
│ [グラフ表示: 月次推移]                                   │
└─────────────────────────────────────────────────────────┘
```

#### 求人統計

```
┌─────────────────────────────────────────────────────────┐
│ 求人統計                                                 │
├─────────────────────────────────────────────────────────┤
│ 求人投稿数: 125件                                        │
│ 応募数: 450件                                            │
│ 応募率: 3.6件/求人                                       │
│                                                          │
│ [グラフ表示: 月次推移]                                   │
└─────────────────────────────────────────────────────────┘
```

#### 契約統計

```
┌─────────────────────────────────────────────────────────┐
│ 契約統計                                                 │
├─────────────────────────────────────────────────────────┤
│ 契約成立: 38件                                           │
│ 成約率: 8.4%                                             │
│ 平均契約期間: 28.5日                                     │
│                                                          │
│ [グラフ表示: 月次推移]                                   │
└─────────────────────────────────────────────────────────┘
```

#### 売上統計

```
┌─────────────────────────────────────────────────────────┐
│ 売上統計                                                 │
├─────────────────────────────────────────────────────────┤
│ 手数料総額: 12,500,000円                                 │
│ 平均: 328,947円/契約                                     │
│ 前月比: +15%                                             │
│                                                          │
│ [グラフ表示: 月次推移]                                   │
└─────────────────────────────────────────────────────────┘
```

### 10.2 詳細レポート

#### レポート出力

```
[詳細レポート出力] [CSV出力] [Excel出力] [PDF出力]
```

#### レポート項目

- ユーザー登録数（薬局・薬剤師別）
- 求人投稿数・応募数
- 契約成立数・成約率
- 売上（手数料）推移
- 都道府県別統計
- 平均日給・平均契約期間

---

## 11. データエクスポート

### 11.1 エクスポート機能

#### 対応形式

- **CSV**: テーブルデータのエクスポート
- **Excel**: フォーマット付きエクスポート
- **PDF**: レポート形式のエクスポート

#### エクスポート可能なデータ

- 薬剤師一覧・詳細
- 薬局一覧・詳細
- 契約一覧・詳細
- 支払い一覧・詳細
- 書類一覧
- 統計レポート

### 11.2 エクスポート設定

```
【データエクスポート】

エクスポート対象: [薬剤師一覧 ▼]
期間: [すべて] [カスタム: 2026/01/01 〜 2026/01/31]
フィルター: [すべて] [確認済みのみ] [カスタム]

出力形式: [CSV] [Excel] [PDF]

出力項目:
☑ ID
☑ 氏名
☑ メールアドレス
☑ 電話番号
☑ 住所
☑ 免許番号
☑ 証明書ステータス
☑ 登録日

[エクスポート実行]
```

---

## 12. 監査ログ

### 12.1 ログ一覧

```
【監査ログ】

検索: [ユーザー、アクション、IPで検索...] [🔍]

フィルター:
├─ アクション: [すべて ▼] [証明書承認] [支払い確認] [アカウント停止] ...
├─ 管理者: [すべて ▼] [管理者A] [管理者B] ...
└─ 日時: [期間選択] [今日] [今週] [今月] [カスタム]

┌────────────────────────────────────────────────────────────────────────────┐
│ 日時 │管理者 │アクション │対象 │IPアドレス │詳細│
├────────────────────────────────────────────────────────────────────────────┤
│2026/01/28 15:00│管理者A│支払い確認│契約#1234│192.168.1.1│👁│
│2026/01/28 14:30│管理者A│証明書承認│薬剤師#123│192.168.1.1│👁│
│2026/01/28 13:15│管理者B│アカウント停止│薬局#002│192.168.1.2│👁│
└────────────────────────────────────────────────────────────────────────────┘

[CSV出力] [ページネーション: ← 前へ] 1 / 100 [次へ →]
```

### 12.2 ログ詳細

```
【ログ詳細】

日時: 2026年1月28日 15:00
管理者: 管理者 A（admin@example.com）
アクション: 支払い確認
対象: 契約ID #1234（請求書ID: INV-001）
IPアドレス: 192.168.1.1
ユーザーエージェント: Mozilla/5.0...

変更内容:
- payments.paymentStatus: reported → confirmed
- payments.confirmedAt: null → 2026-01-28 15:00:00
- contracts.status: pending_payment → active
- contracts.paymentConfirmedAt: null → 2026-01-28 15:00:00

メモ: 入金確認完了。金額・名義人ともに一致。
```

### 12.3 ログ記録項目

すべての管理操作を記録：

- 証明書承認・差し戻し
- 支払い確認・確認失敗
- アカウント停止・復旧
- ペナルティ適用・解除
- データ編集
- エクスポート実行

---

## 13. API設計

### 13.1 認証API

```
POST /api/admin/auth/login
Request: { email, password }
Response: { token, admin: { id, name, role } }

POST /api/admin/auth/logout
Request: { token }
Response: { success: true }

GET /api/admin/auth/me
Request: { token }
Response: { admin: { id, name, role, email } }
```

### 13.2 薬剤師管理API

```
GET /api/admin/pharmacists
Query: { page, limit, search, status, verificationStatus, ... }
Response: { data: Pharmacist[], total, page, limit }

GET /api/admin/pharmacists/:id
Response: { pharmacist: Pharmacist, certificates: Certificate[] }

PATCH /api/admin/pharmacists/:id
Request: { verificationStatus, ... }
Response: { pharmacist: Pharmacist }

GET /api/admin/pharmacists/:id/certificates
Response: { certificates: Certificate[] }

POST /api/admin/pharmacists/:id/certificates/:certId/verify
Request: { status, comment }
Response: { certificate: Certificate }
```

### 13.3 薬局管理API

```
GET /api/admin/pharmacies
Query: { page, limit, search, status, ... }
Response: { data: Pharmacy[], total, page, limit }

GET /api/admin/pharmacies/:id
Response: { pharmacy: Pharmacy, jobPostings: JobPosting[], contracts: Contract[] }

PATCH /api/admin/pharmacies/:id
Request: { isActive, ... }
Response: { pharmacy: Pharmacy }
```

### 13.4 契約管理API

```
GET /api/admin/contracts
Query: { page, limit, search, status, ... }
Response: { data: Contract[], total, page, limit }

GET /api/admin/contracts/:id
Response: { contract: Contract, documents: Document[], payment: Payment }

PATCH /api/admin/contracts/:id
Request: { status, ... }
Response: { contract: Contract }
```

### 13.5 書類管理API

```
GET /api/admin/documents
Query: { page, limit, contractId, documentType, ... }
Response: { data: Document[], total, page, limit }

GET /api/admin/documents/:id
Response: { document: Document }

GET /api/admin/documents/:id/download
Response: PDF file stream
```

### 13.6 支払い管理API

```
GET /api/admin/payments
Query: { page, limit, status, ... }
Response: { data: Payment[], total, page, limit }

GET /api/admin/payments/:id
Response: { payment: Payment, contract: Contract }

POST /api/admin/payments/:id/confirm
Request: { confirmed, comment }
Response: { payment: Payment }
```

### 13.7 統計API

```
GET /api/admin/statistics/summary
Query: { startDate, endDate }
Response: { 
  pharmacies: { total, new },
  pharmacists: { total, new },
  jobPostings: { total, active },
  contracts: { total, active },
  payments: { pending, confirmed, total }
}

GET /api/admin/statistics/reports
Query: { type, startDate, endDate }
Response: { data: ReportData[] }
```

---

## 14. データベース設計

### 14.1 新規テーブル

#### admins（管理者）

```prisma
model Admin {
  id        BigInt   @id @default(autoincrement())
  email     String   @unique @db.VarChar(255)
  password  String   @map("password_hash") @db.VarChar(255)
  name      String   @db.VarChar(100)
  role      String   @default("admin") @db.VarChar(20)
  isActive  Boolean  @default(true) @map("is_active")
  lastLoginAt DateTime? @map("last_login_at")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  auditLogs AuditLog[]
  
  @@map("admins")
}
```

#### audit_logs（監査ログ）

```prisma
model AuditLog {
  id          BigInt   @id @default(autoincrement())
  adminId     BigInt   @map("admin_id")
  action      String   @db.VarChar(50)
  targetType  String?  @map("target_type") @db.VarChar(50)
  targetId    BigInt?  @map("target_id")
  details     Json?
  ipAddress   String?  @map("ip_address") @db.VarChar(45)
  userAgent   String?  @map("user_agent") @db.Text
  createdAt   DateTime @default(now()) @map("created_at")
  
  admin       Admin    @relation(fields: [adminId], references: [id])
  
  @@index([adminId], map: "idx_audit_logs_admin_id")
  @@index([action], map: "idx_audit_logs_action")
  @@index([targetType, targetId], map: "idx_audit_logs_target")
  @@index([createdAt], map: "idx_audit_logs_created_at")
  @@map("audit_logs")
}
```

### 14.2 既存テーブルの活用

既存のテーブルをそのまま活用：

- `users` - ユーザー認証情報
- `pharmacists` - 薬剤師情報
- `pharmacies` - 薬局情報
- `contracts` - 契約情報
- `payments` - 支払い情報
- `documents` - 書類情報
- `certificates` - 資格証明書
- `job_postings` - 求人情報
- `applications` - 応募情報

### 14.3 リレーション

```
admins
  └─ audit_logs

pharmacists
  ├─ certificates
  ├─ applications
  └─ contracts

pharmacies
  ├─ job_postings
  ├─ contracts
  └─ payments

contracts
  ├─ documents
  └─ payment
```

---

## 15. 実装優先順位

### Phase 1: 基本機能（必須）
1. 管理者認証・ログイン
2. ダッシュボード（サマリー表示）
3. 薬剤師一覧・詳細
4. 薬局一覧・詳細
5. 支払い確認機能

### Phase 2: 管理機能（重要）
1. 資格証明書確認機能
2. 契約一覧・詳細
3. 書類管理・紐付け確認
4. 統計・レポート

### Phase 3: 拡張機能（推奨）
1. データエクスポート
2. 監査ログ詳細
3. 高度な検索・フィルター
4. バッチ処理機能

---

## 16. セキュリティ考慮事項

### 16.1 認証・認可
- JWTトークンによる認証
- ロールベースアクセス制御（RBAC）
- セッションタイムアウト（24時間）

### 16.2 データ保護
- 個人情報の暗号化（必要に応じて）
- アクセスログの記録
- データエクスポート時の権限チェック

### 16.3 監査
- すべての操作をログに記録
- 変更履歴の保持
- 定期的なログレビュー

---

## 17. 既存システムとの整合性

### 17.1 データベーススキーマ
- 既存のPrismaスキーマをそのまま活用
- 新規テーブル（`admins`, `audit_logs`）のみ追加

### 17.2 API設計
- 既存のAPIエンドポイントと統一された設計
- RESTful API原則に準拠

### 17.3 認証システム
- 既存のJWT認証システムと統合
- 管理者専用の認証エンドポイントを追加

---

**最終更新**: 2026年1月28日

