# PDF文字化け問題の解決ガイド

## 🔍 問題の原因

PDFKitはデフォルトでHelveticaフォントを使用しますが、このフォントは**日本語をサポートしていません**。そのため、日本語テキストが文字化けします。

## ✅ 解決方法

### 方法1: システムフォントを使用（現在の実装）

現在の実装では、システムにインストールされている日本語フォントを自動検出して使用します。

**対応OS:**
- **macOS**: ヒラギノ角ゴシック、AppleGothic
- **Linux**: Noto Sans CJK
- **Windows**: MSゴシック、MS明朝

**メリット:**
- 追加のファイル不要
- すぐに使える

**デメリット:**
- サーバー環境によっては利用できない場合がある
- フォントが異なる環境で見た目が変わる可能性

---

### 方法2: プロジェクトにフォントファイルを配置（推奨）

最も確実な方法は、プロジェクトに日本語フォントファイルを含めることです。

#### 手順

1. **フォントファイルをダウンロード**

   Noto Sans JP（推奨）:
   - https://fonts.google.com/noto/specimen/Noto+Sans+JP
   - 「Download family」から `NotoSansJP-Regular.ttf` をダウンロード

2. **フォントファイルを配置**

   ```
   backend/
   └── fonts/
       └── NotoSansJP-Regular.ttf
   ```

3. **コードは既に対応済み**

   現在の実装では、`backend/fonts/NotoSansJP-Regular.ttf` を自動的に検出します。

---

## 🧪 テスト方法

### 1. 現在の実装をテスト

```bash
# バックエンドを再起動
cd backend
npm run dev
```

### 2. PDFを生成して確認

1. 薬局としてログイン
2. 契約詳細ページに移動
3. 請求書をダウンロード
4. PDFを開いて日本語が正しく表示されるか確認

---

## 🔧 トラブルシューティング

### 問題1: まだ文字化けする

**原因:**
- システムに日本語フォントがインストールされていない
- フォントファイルのパスが間違っている

**解決方法:**
1. プロジェクトにフォントファイルを配置（方法2を参照）
2. フォントファイルのパスを確認

### 問題2: フォントが見つからないエラー

**ログを確認:**
```bash
# バックエンドのログで確認
日本語フォントの登録に失敗しました: ...
```

**解決方法:**
1. フォントファイルが存在するか確認
2. ファイルパスの権限を確認
3. フォントファイルの形式（.ttf, .ttc）を確認

### 問題3: 一部の文字だけ文字化けする

**原因:**
- フォントに含まれていない文字（特殊記号など）

**解決方法:**
- より包括的なフォント（Noto Sans CJK）を使用
- 文字を置き換える

---

## 📝 推奨フォント

### 1. Noto Sans JP（推奨）
- **ライセンス**: SIL Open Font License（商用利用可）
- **文字数**: 日本語全文字対応
- **ファイルサイズ**: 約5MB
- **ダウンロード**: https://fonts.google.com/noto/specimen/Noto+Sans+JP

### 2. Noto Serif JP
- **特徴**: セリフ体（明朝体風）
- **用途**: より正式な文書向け

### 3. ヒラギノ角ゴシック（macOSのみ）
- **特徴**: macOS標準フォント
- **用途**: macOS環境での開発時

---

## 🎯 最適な実装方法

### 本番環境での推奨設定

1. **フォントファイルをプロジェクトに含める**
   ```
   backend/fonts/NotoSansJP-Regular.ttf
   ```

2. **.gitignoreに追加しない**
   ```gitignore
   # フォントファイルは含める
   # backend/fonts/*.ttf
   ```

3. **Docker環境の場合**
   ```dockerfile
   # フォントファイルをコピー
   COPY backend/fonts/ /app/fonts/
   ```

---

## 📊 現在の実装状況

### ✅ 実装済み
- システムフォントの自動検出
- プロジェクト内フォントの検出
- フォントが見つからない場合のフォールバック

### 🔄 今後の改善案
- [ ] フォントファイルをプロジェクトに追加
- [ ] フォントの太字バージョン（Bold）を追加
- [ ] フォントキャッシュの実装

---

## 💡 補足情報

### PDFKitのフォント登録方法

```typescript
// フォントを登録
doc.registerFont('Japanese', '/path/to/font.ttf');

// フォントを使用
doc.font('Japanese').text('日本語テキスト');
```

### フォントファイルの形式

- **.ttf**: TrueType Font（推奨）
- **.ttc**: TrueType Collection（複数フォントを含む）
- **.otf**: OpenType Font

---

## 🎉 まとめ

現在の実装で、システムフォントが利用可能な場合は自動的に日本語が表示されます。

**より確実にするには:**
1. `backend/fonts/NotoSansJP-Regular.ttf` を配置
2. バックエンドを再起動
3. PDFを再生成

これで文字化け問題は解決します！

